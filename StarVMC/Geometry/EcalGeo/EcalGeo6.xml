<Document file="StarVMC/Geometry/EcalGeo/EcalGeo6.xml"  >

    <Replace match="GeV">*1.0E+0;</Replace>    
    <Replace match="MeV">*1.0E-3;</Replace>    
    <Replace match="keV">*1.0E-6;</Replace>
 

    <Replace match="SET EmCuts(#)"  >
        IF ( #1_Version .gt. 0 ) THEN ;
        Call GsTPar( ag_imed, 'CUTGAM', #1_CUTGAM );
        Call GsTPar( ag_imed, 'CUTELE', #1_CUTELE );
        Call GsTPar( ag_imed, 'CUTHAD', #1_CUTHAD );
        Call GsTPar( ag_imed, 'CUTNEU', #1_CUTNEU );
        Call GsTPar( ag_imed, 'CUTMUO', #1_CUTMUO );
        Call GsTPar( ag_imed, 'DCUTE', #1_DCUTE );
        Call GsTPar( ag_imed, 'DCUTM', #1_DCUTM );
        Call GsTPar( ag_imed, 'BCUTE', #1_BCUTE );
        Call GsTPar( ag_imed, 'BCUTM', #1_BCUTM );
        ENDIF ;
    </Replace>
               
    <Module name="ECALGEO6" comment=" is the EM EndCap Calorimeter GEOmetry "  >
        <Created date="   11/13/2009 "  />
        <Author name="Jason Webb, Hal Spinka, Ilya Selyuzhenkov, Alice Bridgeman, Keith Krueger, Michael Betancourt"  />
 
        <CDE  >
            AGECOM
            GCONST
            GCUNIT
        </CDE>
        
        <Content  >
            EAGA,EALP,ECAL,ECHC,ECVO,ECGH,EFLP,EHMS,ELED,EMGT,EMOD,EPER,EPSB,ERAD,ERCM,ERSM,ESHM,ESEC,ESCI,ESPL,ESSP,EMSS,ETAR,EXSG,EXPS,EFLS,EBLS
        </Content>
                       
        <Structure name="EMCG"  >
            <var name="Version" type="float"  />
            <var name="onoff" type="int"  />
            <var name="fillmode" type="int"  />
        </Structure>
        
        <Structure name="EMCS"  >
            <var name="Version" type="float"  />
            <var name="Type" type="float"  />
            <var name="zorg" type="float"  />
            <var name="zend" type="float"  />
            <var name="EtaMin" type="float"  />
            <var name="EtaMax" type="float"  />
            <var name="PhiMin" type="float"  />
            <var name="PhiMax" type="float"  />
            <var name="Offset" type="float"  />
            <var name="Nsupsec" type="float"  />
            <var name="Nsector" type="float"  />
            <var name="Nsection" type="float"  />
            <var name="Nslices" type="float"  />
            <var name="Front" type="float"  />
            <var name="AlinCell" type="float"  />
            <var name="Frplast" type="float"  />
            <var name="Bkplast" type="float"  />
            <var name="PbPlate" type="float"  />
            <var name="LamPlate" type="float"  />
            <var name="BckPlate" type="float"  />
            <var name="Hub" type="float"  />
            <var name="Rmshift" type="float"  />
            <var name="SMShift" type="float"  />
            <var name="GapPlt" type="float"  />
            <var name="GapCel" type="float"  />
            <var name="GapSMD" type="float"  />
            <var name="SMDcentr" type="float"  />
            <var name="TieRod(2)" type="float"  />
            <var name="Bckfrnt" type="float"  />
            <var name="GapHalf" type="float"  />
            <var name="Cover" type="float"  />
            <var name="Rtie" type="float"  />
            <var name="slop" type="float"  />
        </Structure>
        

        <Structure name="EETR"  >
            <var name="Type" type="float"  />
            <var name="Etagr" type="float"  />
            <var name="Phigr" type="float"  />
            <var name="Neta" type="float"  />
            <var name="EtaBin(13)" type="float"  />
        </Structure>
        

        <Structure name="ESEC"  >
            <var name="Isect" type="float"  />
            <var name="FPlmat" type="float"  />
            <var name="Cell" type="float"  />
            <var name="Scint" type="float"  />
            <var name="Nlayer" type="float"  />
            <var name="deltaz" type="float"  />
            <var name="Jiggle(18)" type="float"  />
        </Structure>
        

        <Structure name="EMXG"  >
            <var name="Version" type="float"  />
            <var name="Sapex" type="float"  />
            <var name="Sbase" type="float"  />
            <var name="Rin" type="float"  />
            <var name="Rout" type="float"  />
            <var name="F4" type="float"  />
        </Structure>
        

        <Structure name="EXSE"  >
            <var name="Jsect" type="float"  />
            <var name="Zshift" type="float"  />
            <var name="Sectype(6)" type="float"  />
        </Structure>
        

        <Structure name="ESMD"  >
            <var name="Version" type="float"  />
            <var name="front_layer" type="float"  />
            <var name="back_layer" type="float"  />
            <var name="spacer_layer" type="float"  />
            <var name="base" type="float"  />
            <var name="apex" type="float"  />
        </Structure>
        

        <Structure name="ECUT"  >
            <var name="Version" type="float"  />
            <var name="Absorber" type="float"  />
            <var name="Sensitive" type="float"  />
            <var name="Blah" type="float"  />
        </Structure>
        
        <Structure name="EABS"  >
            <var name="Version" type="float"  />
            <var name="CUTGAM" type="float"  />
            <var name="CUTELE" type="float"  />
            <var name="CUTNEU" type="float"  />
            <var name="CUTHAD" type="float"  />
            <var name="CUTMUO" type="float"  />
            <var name="DCUTE" type="float"  />
            <var name="DCUTM" type="float"  />
            <var name="BCUTE" type="float"  />
            <var name="BCUTM" type="float"  />
        </Structure>
        
        <Structure name="ESEN"  >
            <var name="Version" type="float"  />
            <var name="CUTGAM" type="float"  />
            <var name="CUTELE" type="float"  />
            <var name="CUTNEU" type="float"  />
            <var name="CUTHAD" type="float"  />
            <var name="CUTMUO" type="float"  />
            <var name="DCUTE" type="float"  />
            <var name="DCUTM" type="float"  />
            <var name="BCUTE" type="float"  />
            <var name="BCUTM" type="float"  />
        </Structure>
        

        <varlist type="INTEGER"  >
            I_section,J_section,Ie,is,isec,istrip,Nstr,Type,ii,jj,cut,fsect,lsect,ihalf,filled,i,j,k,i_sector
        </varlist>
        
        <varlist type="REAL"  >
            center,Plate,Cell,G10,halfi,tan_low,tan_upp,RBot,Rtop,Deta,sq2,sq3,dup,dd,d2,d3,rshift,dphi,radiator
        </varlist>
        
        <varlist type="REAL"  >
            maxcnt,msecwd,mxgten,curr,Secwid,Section,curcl,EtaTop,EtaBot,zwidth,zslice,Gap,megatile,xleft,xright,yleft,yright,current,rth,length,p,xc,yc,xx,yy,rdel,dxy,ddn,ddup
        </varlist>
        

        <varlist type="REAL"  >
            myPhi
        </varlist>
        
        <varlist type="INTEGER"  >
            N
        </varlist>
        
        <Parameter name="N" value="12"  />

<Export language="AgROOT|Mortran">
        <Inline name="tanf" type="real"> 
        	<Arguement type="real" name="etax" />
        	<Return value="tan(2*atan(exp(-etax)))" />
        </Inline>   
</Export>

        <Fill name="EMCG" comment="EM EndCAp Calorimeter basic data"  >
            <var name="Version" value="6.1" comment=" Geometry version  "  />
            <var name="OnOff" value="3" comment=" Configurations 0-no, 1-west 2-east 3-both "  />
            <var name="FillMode" value="3" comment=" sectors fill mode  "  />
        </Fill>
        
        <Fill name="EMCS" comment="EM Endcap Calorimeter geometry"  >
            <var name="Version" value="1" comment=" Versioning "  />
            <var name="Type" value="1" comment=" =1 endcap, =2 fpd edcap prototype "  />
            <var name="ZOrg" value="268.763" comment=" calorimeter origin in z "  />
            <var name="ZEnd" value="310.007" comment=" Calorimeter end in z "  />
            <var name="EtaMin" value="1.086" comment=" upper feducial eta cut  "  />
            <var name="EtaMax" value="2.000" comment=" lower fiducial eta cut  " />
            <var name="PhiMin" value="-90" comment=" Min phi  "  />
            <var name="PhiMax" value="90" comment=" Max phi "  />
            <var name="Offset" value="0.0" comment=" offset in x "  />
            <var name="Nsupsec" value="6" comment=" Number of azimuthal supersectors         "  />
            <var name="Nsector" value="30" comment=" Number of azimutal sectors (Phi granularity) "  />
            <var name="Nslices" value="5" comment=" number of phi slices in supersector "  />
            <var name="Nsection" value="4" comment=" Number of readout sections "  />
            <var name="Front" value="0.953" comment=" thickness of the front AL plates "  />
            <var name="AlinCell" value="0.02" comment=" Aluminim plate in cell "  />
            <var name="Frplast" value="0.015" comment=" Front plastic in megatile "  />
            <var name="Bkplast" value="0.155" comment=" Fiber routing guides and back plastic "  />
            <var name="Pbplate" value="0.457" comment=" Lead radiator thickness "  />
            <var name="LamPlate" value="0.05" comment=" Laminated SS plate thickness "  />
            <var name="BckPlate" value="3.175" comment=" Back SS plate thickness "  />
            <var name="Hub" value="3.81" comment=" thickness of EndCap hub "  />
            <var name="Rmshift" value="2.121" comment=" radial shift of module "  />
            <var name="smshift" value="0.12" comment=" radial shift of steel support walls "  />
            <var name="GapPlt" value="0.3/2" comment=" HALF of the inter-plate gap in phi "  />
            <var name="GapCel" value="0.03/2" comment=" HALF of the radial inter-cell gap "  />
            <var name="GapSMD" value="3.400" comment=" space for SMD detector                &lt;&lt; version 2 -- 3.600 &gt;&gt; "  />
            <var name="SMDcentr" value="279.542" comment=" SMD position "  />
            <var name="TieRod" value="{160.,195}" comment=" Radial position of tie rods "  />
            <var name="Bckfrnt" value="306.832" comment=" Backplate front Z "  />
            <var name="GapHalf" value="0.4" comment=" 1/2 Gap between halves of endcap wheel "  />
            <var name="Cover" value="0.075" comment=" Cover of wheel half "  />
            <var name="Rtie" value="1.0425" comment=" Radius of tie rod "  />
            <var name="Slop" value="0.1400" comment=" Added to cell containing radiator 6 (formerly hardcoded in geom) "  />
        </Fill>
        
        <Fill name="EMCS" comment="EM Endcap Calorimeter geometry"  >
            <var name="Version" value="2" comment=" Versioning "  />
            <var name="Type" value="1" comment=" =1 endcap, =2 fpd edcap prototype "  />
            <var name="ZOrg" value="268.763" comment=" calorimeter origin in z "  />
            <var name="ZEnd" value="310.007" comment=" Calorimeter end in z "  />
            <var name="EtaMin" value="1.086" comment=" upper feducial eta cut  "  />
            <var name="EtaMax" value="2.000" comment=" lower fiducial eta cut  " />
            <var name="PhiMin" value="-90" comment=" Min phi  "  />
            <var name="PhiMax" value="90" comment=" Max phi "  />
            <var name="Offset" value="0.0" comment=" offset in x "  />
            <var name="Nsupsec" value="6" comment=" Number of azimuthal supersectors         "  />
            <var name="Nsector" value="30" comment=" Number of azimutal sectors (Phi granularity) "  />
            <var name="Nslices" value="5" comment=" number of phi slices in supersector "  />
            <var name="Nsection" value="4" comment=" Number of readout sections "  />
            <var name="Front" value="0.953" comment=" thickness of the front AL plates "  />
            <var name="AlinCell" value="0.02" comment=" Aluminim plate in cell "  />
            <var name="Frplast" value="0.015" comment=" Front plastic in megatile "  />
            <var name="Bkplast" value="0.155" comment=" Fiber routing guides and back plastic "  />
            <var name="Pbplate" value="0.457" comment=" Lead radiator thickness "  />
            <var name="LamPlate" value="0.05" comment=" Laminated SS plate thickness "  />
            <var name="BckPlate" value="3.175" comment=" Back SS plate thickness "  />
            <var name="Hub" value="3.81" comment=" thickness of EndCap hub "  />
            <var name="Rmshift" value="2.121" comment=" radial shift of module "  />
            <var name="smshift" value="0.12" comment=" radial shift of steel support walls "  />
            <var name="GapPlt" value="0.3/2" comment=" HALF of the inter-plate gap in phi "  />
            <var name="GapCel" value="0.03/2" comment=" HALF of the radial inter-cell gap "  />
            <var name="GapSMD" value="3.600" comment=" space for SMD detector              (* from master_geom_bmp.xls *) "  />
            <var name="SMDcentr" value="279.542" comment=" SMD position "  />
            <var name="TieRod" value="{160.,195}" comment=" Radial position of tie rods "  />
            <var name="Bckfrnt" value="306.832" comment=" Backplate front Z "  />
            <var name="GapHalf" value="0.4" comment=" 1/2 Gap between halves of endcap wheel "  />
            <var name="Cover" value="0.075" comment=" Cover of wheel half "  />
            <var name="Rtie" value="0.75" comment=" Radius of tie rod "  />
            <var name="Slop" value="0.0000" comment=" Added to cell containing radiator 6 (formerly hardcoded in geom) "  />
        </Fill>
        
        <Fill name="ESMD" comment="shower maximum detector information"  >
            <var name="Version" value="1" comment=" versioning information "  />
            <var name="front_layer" value="0.161" comment=" thickness of front layer  "  />
            <var name="back_layer" value="0.210" comment=" thickness of back layer "  />
            <var name="base" value="1.0" comment=" base of the SMD strip "  />
            <var name="apex" value="0.7" comment=" apex of the SMD strip "  />
            <var name="spacer_layer" value="1.2" comment=" spacer layer "  />
        </Fill>
        
        <Fill name="EETR" comment="Eta and Phi grid values"  >
            <var name="Type" value="1" comment=" =1 endcap, =2 fpd "  />
            <var name="EtaGr" value="1.0536" comment=" eta_top/eta_bot tower granularity "  />
            <var name="PhiGr" value="0.0981747" comment=" Phi granularity (radians) "  />
            <var name="NEta" value="12" comment=" Eta granularity "  />
            <var name="EtaBin" value="{2.0,1.9008,1.8065,1.7168,1.6317,1.5507,1.4738,1.4007,1.3312,1.2651,1.2023,1.1427,1.086}" comment=" Eta rapidities "  />
        </Fill>
        
        <Fill name="ESEC" comment="Preshower 1 / Radiator 1"  >
            <var name="ISect" value="1" comment=" Section number    "  />
            <var name="Nlayer" value="1" comment=" Number of Sci layers along z "  />
            <var name="Cell" value="1.505" comment=" Cell full width in z "  />
            <var name="Scint" value="0.475" comment=" Sci layer thickness (4.75mm Bicron) "  />
            <var name="deltaz" value="-0.014" comment=" Amount to shift section in z to align with as-built numbers "  />
            <var name="Jiggle" value="{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}" comment=" Degrees to shift EPER in each layer "  />
        </Fill>
        
        <Fill name="ESEC" comment="Preshower 2 / Radiator 2"  >
            <var name="ISect" value="2" comment=" Section number    "  />
            <var name="Nlayer" value="1" comment=" Number of Sci layers along z "  />
            <var name="Cell" value="1.505" comment=" Cell full width in z "  />
            <var name="Scint" value="0.475" comment=" Sci layer thickness (4.75mm Bicron) "  />
            <var name="deltaz" value="-0.0182" comment=" Amount to shift section in z to align with as-built numbers "  />
            <var name="Jiggle" value="{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}" comment=" Degrees to shift EPER in each layer "  />
        </Fill>
        
        <Fill name="ESEC" comment="Megatiles 3-6 / Radiators 3-5"  >
            <var name="ISect" value="3" comment=" Section number "  />
            <var name="Nlayer" value="4" comment=" Number of Sci layers along z "  />
            <var name="Cell" value="1.405" comment=" Cell full width in z "  />
            <var name="Scint" value="0.4" comment=" Sci layer thickness "  />
            <var name="deltaz" value="-0.0145" comment=" Amount to shift section in z to align with as-built numbers "  />
            <var name="Jiggle" value="{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}" comment=" Degrees to shift EPER in each layer "  />
        </Fill>
        
        <Fill name="ESEC" comment="Megatiles 7-23 / Radiators 6-23"  >
            <var name="ISect" value="4" comment=" Section "  />
            <var name="Nlayer" value="18" comment=" Number of layers along z "  />
            <var name="Cell" value="1.405" comment=" Cell full width in z "  />
            <var name="Scint" value="0.4" comment=" Sci layer thickness "  />
            <var name="deltaz" value="+0.0336" comment=" Amount to shift section in z to align with as-built numbers "  />
            <var name="Jiggle" value="{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}" comment=" Degrees to shift EPER in each layer "  />
        </Fill>
        
        <Fill name="ESEC" comment="Postshower"  >
            <var name="ISect" value="5" comment=" Section "  />
            <var name="Nlayer" value="1" comment=" Number of  layers along z "  />
            <var name="Cell" value="1.505" comment=" Cell full width in z "  />
            <var name="Scint" value="0.5" comment=" Sci layer thickness (5.0mm Kurarary) "  />
            <var name="deltaz" value="+0.036" comment=" Amount to shift section in z to align with as-built numbers "  />
            <var name="Jiggle" value="{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}" comment=" Degrees to shift EPER in each layer "  />
        </Fill>
        
        <Fill name="EMXG" comment="EM Endcap SMD basic data"  >
            <var name="Version" value="1" comment=" Geometry version "  />
            <var name="Sapex" value="0.7" comment=" Scintillator strip apex "  />
            <var name="Sbase" value="1.0" comment=" Scintillator strip base "  />
            <var name="Rin" value="77.41" comment=" inner radius of SMD plane   "  />
            <var name="Rout" value="213.922" comment=" outer radius of SMD plane "  />
            <var name="F4" value=".15" comment=" F4 thickness "  />
        </Fill>
        
        <Fill name="EXSE" comment="First SMD section"  >
            <var name="JSect" value="1" comment=" Section number "  />
            <var name="Zshift" value="-1.215" comment=" Section width "  />
            <var name="sectype" value="{4,1,0,2,1,0}" comment=" 1-V,2-U,3-cutV,4-cutU     "  />
        </Fill>
        
        <Fill name="EXSE" comment="Second SMD section"  >
            <var name="JSect" value="2" comment=" Section number    "  />
            <var name="Zshift" value="0." comment=" Section width "  />
            <var name="sectype" value="{0,2,1,0,2,3}" comment=" 1-V,2-U,3-cutV,4-cutU     "  />
        </Fill>
        
        <Fill name="EXSE" comment="Third SMD section"  >
            <var name="JSect" value="3" comment=" Section number    "  />
            <var name="Zshift" value="1.215" comment=" Section width "  />
            <var name="sectype" value="{1,0,2,1,0,2}" comment=" 1-V,2-U,3-cutV,4-cutU     "  />
        </Fill>
        
        <Fill name="ECUT" comment="cut selection"  >
            <var name="Version" value="1" comment=" selector "  />
            <var name="Absorber" value="0" comment=" absorber cuts "  />
            <var name="Sensitive" value="0" comment=" sensitive cuts "  />
            <var name="Blah" value="1" comment=" meh "  />

        </Fill>
        
        <Fill name="EABS" comment="The values below are the untuned defaults in the original geometry"  >
            <var name="Version" value="0" comment=" versioning "  />
            <var name="CutGAM" value="80 keV" comment=" gamma transport cut "  />
            <var name="CutELE" value="1 MeV" comment=" electron transport cut "  />
            <var name="CutHAD" value="1 MeV" comment=" hadron transport cut "  />
            <var name="CutNEU" value="1 MeV" comment=" neutron transport cut "  />
            <var name="CutMUO" value="1 MeV" comment=" muon transport cut "  />
            <var name="DCutE" value="1 MeV" comment=" electron delta ray cut "  />
            <var name="DCutM" value="1 MeV" comment=" muon delta ray cut "  />
            <var name="BCutE" value="100 keV" comment=" electron brem cut "  />
            <var name="BCutM" value="1 MeV" comment=" muon brem cut      "  />

        </Fill>
        
        <Fill name="EABS" comment="EM cuts in absorbing material"  >
            <var name="Version" value="1" comment=" versioning "  />
            <var name="CutGAM" value="10 keV" comment=" gamma transport cut "  />
            <var name="CutELE" value="10 keV" comment=" electron transport cut "  />
            <var name="CutHAD" value="1 MeV" comment=" hadron transport cut "  />
            <var name="CutNEU" value="1 MeV" comment=" neutron transport cut "  />
            <var name="CutMUO" value="1 MeV" comment=" muon transport cut "  />
            <var name="DCutE" value="10 keV" comment=" electron delta ray cut "  />
            <var name="DCutM" value="10 keV" comment=" muon delta ray cut "  />
            <var name="BCutE" value="10 keV" comment=" electron brem cut "  />
            <var name="BCutM" value="10 keV" comment=" muon brem cut "  />

        </Fill>
        
        <Fill name="EABS" comment="EM cuts in absorbing material"  >
            <var name="Version" value="2" comment=" versioning "  />
            <var name="CutGAM" value="30 keV" comment=" gamma transport cut "  />
            <var name="CutELE" value="30 keV" comment=" electron transport cut "  />
            <var name="CutHAD" value="1 MeV" comment=" hadron transport cut "  />
            <var name="CutNEU" value="1 MeV" comment=" neutron transport cut "  />
            <var name="CutMUO" value="1 MeV" comment=" muon transport cut "  />
            <var name="DCutE" value="30 keV" comment=" electron delta ray cut "  />
            <var name="DCutM" value="30 keV" comment=" muon delta ray cut "  />
            <var name="BCutE" value="30 keV" comment=" electron brem cut "  />
            <var name="BCutM" value="30 keV" comment=" muon brem cut "  />

        </Fill>
        
        <Fill name="EABS" comment="EM cuts in absorbing material"  >
            <var name="Version" value="3" comment=" versioning "  />
            <var name="CutGAM" value="100 keV" comment=" gamma transport cut "  />
            <var name="CutELE" value="100 keV" comment=" electron transport cut "  />
            <var name="CutHAD" value="1 MeV" comment=" hadron transport cut "  />
            <var name="CutNEU" value="1 MeV" comment=" neutron transport cut "  />
            <var name="CutMUO" value="1 MeV" comment=" muon transport cut "  />
            <var name="DCutE" value="100 keV" comment=" electron delta ray cut "  />
            <var name="DCutM" value="100 keV" comment=" muon delta ray cut "  />
            <var name="BCutE" value="100 keV" comment=" electron brem cut "  />
            <var name="BCutM" value="100 keV" comment=" muon brem cut "  />

        </Fill>
        
        <Fill name="EABS" comment="EM cuts in absorbing material"  >
            <var name="Version" value="4" comment=" versioning "  />
            <var name="CutGAM" value="1 MeV" comment=" gamma transport cut "  />
            <var name="CutELE" value="1 MeV" comment=" electron transport cut "  />
            <var name="CutHAD" value="1 MeV" comment=" hadron transport cut "  />
            <var name="CutNEU" value="1 MeV" comment=" neutron transport cut "  />
            <var name="CutMUO" value="1 MeV" comment=" muon transport cut "  />
            <var name="DCutE" value="1 MeV" comment=" electron delta ray cut "  />
            <var name="DCutM" value="1 MeV" comment=" muon delta ray cut "  />
            <var name="BCutE" value="1 MeV" comment=" electron brem cut "  />
            <var name="BCutM" value="1 MeV" comment=" muon brem cut "  />



        </Fill>
        
        <Fill name="ESEN" comment="The values below are the untuned defaults in the original geometry"  >
            <var name="Version" value="0" comment=" versioning "  />
            <var name="CutGAM" value="80 keV" comment=" gamma transport cut "  />
            <var name="CutELE" value="1 MeV" comment=" electron transport cut "  />
            <var name="CutHAD" value="1 MeV" comment=" hadron transport cut "  />
            <var name="CutNEU" value="1 MeV" comment=" neutron transport cut "  />
            <var name="CutMUO" value="1 MeV" comment=" muon transport cut "  />
            <var name="DCutE" value="1 MeV" comment=" electron delta ray cut "  />
            <var name="DCutM" value="1 MeV" comment=" muon delta ray cut "  />
            <var name="BCutE" value="100 keV" comment=" electron brem cut "  />
            <var name="BCutM" value="1 MeV" comment=" muon brem cut      "  />

        </Fill>
        
        <Fill name="ESEN" comment="EM cuts in absorbing material"  >
            <var name="Version" value="1" comment=" versioning "  />
            <var name="CutGAM" value="10 keV" comment=" gamma transport cut "  />
            <var name="CutELE" value="10 keV" comment=" electron transport cut "  />
            <var name="CutHAD" value="1 MeV" comment=" hadron transport cut "  />
            <var name="CutNEU" value="1 MeV" comment=" neutron transport cut "  />
            <var name="CutMUO" value="1 MeV" comment=" muon transport cut "  />
            <var name="DCutE" value="10 keV" comment=" electron delta ray cut "  />
            <var name="DCutM" value="10 keV" comment=" muon delta ray cut "  />
            <var name="BCutE" value="10 keV" comment=" electron brem cut "  />
            <var name="BCutM" value="10 keV" comment=" muon brem cut "  />

        </Fill>
        
        <Fill name="ESEN" comment="EM cuts in absorbing material"  >
            <var name="Version" value="2" comment=" versioning "  />
            <var name="CutGAM" value="30 keV" comment=" gamma transport cut "  />
            <var name="CutELE" value="30 keV" comment=" electron transport cut "  />
            <var name="CutHAD" value="1 MeV" comment=" hadron transport cut "  />
            <var name="CutNEU" value="1 MeV" comment=" neutron transport cut "  />
            <var name="CutMUO" value="1 MeV" comment=" muon transport cut "  />
            <var name="DCutE" value="30 keV" comment=" electron delta ray cut "  />
            <var name="DCutM" value="30 keV" comment=" muon delta ray cut "  />
            <var name="BCutE" value="30 keV" comment=" electron brem cut "  />
            <var name="BCutM" value="30 keV" comment=" muon brem cut "  />

        </Fill>
        
        <Fill name="ESEN" comment="EM cuts in absorbing material"  >
            <var name="Version" value="3" comment=" versioning "  />
            <var name="CutGAM" value="100 keV" comment=" gamma transport cut "  />
            <var name="CutELE" value="100 keV" comment=" electron transport cut "  />
            <var name="CutHAD" value="1 MeV" comment=" hadron transport cut "  />
            <var name="CutNEU" value="1 MeV" comment=" neutron transport cut "  />
            <var name="CutMUO" value="1 MeV" comment=" muon transport cut "  />
            <var name="DCutE" value="100 keV" comment=" electron delta ray cut "  />
            <var name="DCutM" value="100 keV" comment=" muon delta ray cut "  />
            <var name="BCutE" value="100 keV" comment=" electron brem cut "  />
            <var name="BCutM" value="100 keV" comment=" muon brem cut "  />

        </Fill>
        
        <Fill name="ESEN" comment="EM cuts in absorbing material"  >
            <var name="Version" value="4" comment=" versioning "  />
            <var name="CutGAM" value="1 MeV" comment=" gamma transport cut "  />
            <var name="CutELE" value="1 MeV" comment=" electron transport cut "  />
            <var name="CutHAD" value="1 MeV" comment=" hadron transport cut "  />
            <var name="CutNEU" value="1 MeV" comment=" neutron transport cut "  />
            <var name="CutMUO" value="1 MeV" comment=" muon transport cut "  />
            <var name="DCutE" value="1 MeV" comment=" electron delta ray cut "  />
            <var name="DCutM" value="1 MeV" comment=" muon delta ray cut "  />
            <var name="BCutE" value="1 MeV" comment=" electron brem cut "  />
            <var name="BCutM" value="1 MeV" comment=" muon brem cut "  />

        </Fill>
        


        <Use struct="EMCG"  />
        <Use struct="EMCS" select="Version" value="2    "  />
        <Use struct="EETR"  />
        <Use struct="ECUT" select="Version" value="1 "  />
        <Use struct="EABS" select="Version" value="ECUT_Absorber "  />
        <Use struct="ESEN" select="Version" value="ECUT_Sensitive "  />
        sq3 = sqrt(3.)                                ! 1/tan(30deg) = sq3 
        sq2 = sqrt(2.) 
        center  = (emcs_zorg+emcs_zend)/2             ! center of the calorimeter 
        tan_upp = tanf(emcs_etamin)                   ! think this is angle pointing to top of calo 
        tan_low = tanf(emcs_etamax)                   ! think this is angle pointing to bot of calo 
        rth     = sqrt(1. + tan_low*tan_low)          ! ?? 
        rshift  = emcs_hub * rth                      ! ?? 
        dup     = emcs_rmshift*tan_upp                ! 
        dd      = emcs_rmshift*rth                    ! 
        d2      = rshift + dd                         ! 
        radiator  = emcs_pbplate + 2*emcs_lamplate    ! thickness of radiator assembly 
        dphi = (emcs_phimax-emcs_phimin)/emcs_nsector ! single endcap sector 

        <Print level="0" fmt="'ecalgeo version: ', F4.2"  >
            emcg_version 
        </Print>
        
        <Print level="0" fmt="' absorber cuts=', F4.2"  >
            ecut_absorber 
        </Print>
        
        <Print level="0" fmt="' sensitive cuts=', F4.2"  >
            ecut_sensitive 
        </Print>
        
        <If expr="emcg_OnOff&gt;0"  >
            <Create block="ECAL"  />

            <If expr="emcg_OnOff==1|emcg_OnOff==3"  >
                <Placement z="+center" block="ECAL" in="CAVE"  >
                </Placement>
                
            </If>
            
            <If expr="section&gt;emcs_zend"  >
                <Print level="1" fmt="' ECALGEO error: sum of sections exceeds maximum ',2F12.4"  >
                    section,emcs_zend 
                </Print>
                
            </If>
            


            <If expr="emcg_OnOff==2|emcg_OnOff==3"  >
                <Placement z="-center" block="ECAL" in="CAVE"  >
                    <Rotation thetaz="180"  />
                </Placement>
                
            </If>
            



        </If>
        
        <Print level="1" fmt="'ECALGEO finished'"  >
        </Print>
        









        <Block name="ECAL" comment="is one EMC EndCap wheel"  >
            <Material name="Air"  />
            <Material name="ECAL_Air" isvol="0"  />
            <Attribute for="ECAL" seen="0" colo="7"  />
            <Shape type="CONE" rmn1="emcs_zorg*tan_low-d2" rmn2="emcs_zend*tan_low-d2" rmx2="emcs_zend*tan_upp+dup" rmx1="emcs_zorg*tan_upp+dup" dz="(emcs_zend-emcs_zorg)/2"  />
    <Export language="Mortran">
            Set EmCuts (EABS) 
    </Export>
            <Do var="ihalf" from="1" to="2"  >
                filled = 1 
               halfi  = -105 + (ihalf-1)*180 
                <If expr="(ihalf==2&amp;emcg_FillMode&lt;3)"  >
                    filled = 0       
                </If>
                
                <Create block="EAGA"  />
                <Placement block="EAGA"  >
                    <Rotation alphaz="halfi"  />
                </Placement>
                
            </Do>
            
        </Block>
        




        <Block name="EAGA" comment="IS HALF OF WHEEL AIR VOLUME FOR THE ENDCAP MODULE"  >
            <Material name="ECAL_Air"  />
            <Attribute for="EAGA" seen="0" serial="FILLED" colo="1"  />
            <Shape type="CONS" rmn1="emcs_zorg*tan_low-d2" rmn2="emcs_zend*tan_low-d2" rmx2="emcs_zend*tan_upp+dup" rmx1="emcs_zorg*tan_upp+dup" dz="(emcs_zend-emcs_zorg)/2" phi2="emcs_phimax" phi1="emcs_phimin"  />
            <If expr="FILLED.EQ.1"  >
                <Create block="EMSS"  />
                <Placement konly="'MANY'" block="EMSS"  >
                </Placement>
                
                curr  = emcs_zorg  
                curcl = emcs_zend 
                <Create block="ECGH"  />
                <Placement konly="'ONLY'" block="ECGH"  >
                    <Rotation alphaz="90"  />
                </Placement>
                
            </If>
            
        </Block>
        



        <Block name="EMSS" comment="is the steel support of the endcap module"  >

            <Mixture name="Ecal_Steel" dens="8.03"  >
                <Component name="Cr" a="51.9960" z="24" w="0.19"  />
                <Component name="Ni" a="58.6934" z="28" w="0.09"  />
                <Component name="Fe" a="55.8450" z="26" w="0.72"  />
            </Mixture>
            
            <Attribute for="EMSS" seen="1" colo="1"  />
            <Shape type="CONS" rmn1="emcs_zorg*tan_low-d2" rmn2="emcs_zend*tan_low-d2" rmx2="emcs_zend*tan_upp+dup" rmx1="emcs_zorg*tan_upp+dup" dz="(emcs_zend-emcs_zorg)/2" phi2="emcs_phimax" phi1="emcs_phimin"  />

        <Export language="Mortran">
            Set EmCuts (EABS) 
        </Export>

            zslice = emcs_zorg 
            zwidth = emcs_front 
            <Print level="1" fmt="' Front Al plate centered at: ', F12.4"  >
                zslice+zwidth/2 
            </Print>
            
            <Create block="EFLP"  />
            <Placement z="zslice-center+zwidth/2" block="EFLP"  >
            </Placement>
            
            zslice = zslice + zwidth 
            <Print level="1" fmt="' FIRST CALORIMETER STARTS AT: ',F12.4"  >
                zslice 
            </Print>
            
            fsect = 1                                          ! first section  
            lsect = 3                                          ! last section 
            zwidth = emcs_smdcentr - emcs_gapsmd/2 - zslice    ! width of current slice 
            <Print level="1" fmt="'Sections 1-3 positioned at: ', F12.4"  >
                zslice+zwidth/2 
            </Print>
            
            <Create block="ECVO"  />
            <Placement z="zslice-center+zwidth/2" block="ECVO"  >
            </Placement>
            
            zwidth  = emcs_gapsmd 
            zslice  = emcs_smdcentr - emcs_gapsmd/2 
            <Print level="1" fmt="' 1st calorimeter ends, smd starts at: ',2f10.5"  >
                section,zslice 
            </Print>
            
            <Print level="1" fmt="' smd width = ',f10.5"  >
                zwidth 
            </Print>
            
            <Print level="1" fmt="'SMD section centered at: ', F12.4"  >
                zslice+zwidth/2 
            </Print>
            
            <Create block="ESHM"  />
            <Placement z="zslice-center+zwidth/2" konly="'MANY'" block="ESHM"  >
            </Placement>
            
            zslice = zslice + zwidth 
            <Print level="1" fmt="' SMD ends at: ',f10.5"  >
                zslice 
            </Print>
            
            fsect = 4                                             ! first section 
            lsect = 5                                             ! last section 
            zwidth = 0 
            <Do var="i_section" from="fsect" to="lsect"  >
                <Use struct="ESEC" select="isect" value="i_section   "  />
                zwidth  = zwidth + esec_cell*esec_nlayer 
            </Do>
            
            zwidth = emcs_bckfrnt - zslice 
            <Print level="1" fmt="'Sections 4-5 positioned at: ', F12.4"  >
                zslice+zwidth/2 
            </Print>
            
            <Create block="ECVO"  />
            <Placement z="zslice-center+zwidth/2" block="ECVO"  >
            </Placement>
            
            zslice = emcs_bckfrnt 
            <Print level="1" fmt="' 2nd calorimeter ends, back plate starts at: ',2f10.5"  >
                section,zslice 
            </Print>
            
            zwidth  = emcs_bckplate 
            <Create block="ESSP"  />
            <Placement z="zslice-center+zwidth/2" block="ESSP"  >
            </Placement>
            
            zslice = zslice + zwidth 
            <Print level="1" fmt="'EEMC Al backplate ends at: ',F12.4"  >
                zslice 
            </Print>
            
            zwidth = emcs_zend-emcs_zorg 
            <Create block="ERCM"  />
            <Do var="i" from="1" to="2"  >
                <Do var="j" from="1" to="5"  >
                    xx = emcs_phimin + j*30 
                    yy = xx*degrad 
                    xc = cos(yy)*emcs_tierod(i) 
                    yc = sin(yy)*emcs_tierod(i) 
                    <Placement y="yc" x="xc" z="0" block="ERCM"  >
                    </Placement>
                    
                </Do>
                
            </Do>
            
            rth = emcs_zorg*tan_upp+dup + 2.5/2 
            xc = (emcs_zend - emcs_zorg)*tan_upp 
            length = .5*(emcs_zend + emcs_zorg)*tan_upp + dup + 2.5/2 
            yc = emcs_zend-emcs_zorg 
            p = atan(xc/yc)/degrad 
            <Create block="EPSB"  />
            <Do var="i" from="1" to="6"  >
                xx = -75 + (i-1)*30 
                yy = xx*degrad 
                xc = cos(yy)*length 
                yc = sin(yy)*length 
                <Placement y="YC" x="XC" block="EPSB"  >
                    <Rotation alphaz="XX"  />
                </Placement>
                
            </Do>
            
        </Block>
        








        <Block name="ECVO" comment="is one of endcap volume with megatiles and radiators"  >
            <Material name="ECAL_Air"  />
            <Attribute for="ECVO" seen="1" colo="3"  />
            <Shape type="CONS" rmn1="zslice*tan_low-dd" rmn2="(zslice+zwidth)*tan_low-dd" rmx2="(zslice+zwidth)*tan_upp+dup" rmx1="zslice*tan_upp+dup" dz="zwidth/2"  />
            <Do var="i_sector" from="1" to="6"  >
                
            	<If expr=" (1&lt;I_SECTOR .and. I_SECTOR&lt;6)|EMCG_FILLMODE&gt;1"  >
                    filled = 1 
                    <Else  >
                        filled = 0 
                    </Else>
                    
                </If>
                
                d3 = 75 - (i_sector-1)*30 
                <Create block="EMOD"  />
                <Placement ncopy="i_sector" block="EMOD"  >
                    <Rotation alphaz="d3"  />
                </Placement>
                
            </Do>
            
        </Block>
        


        <Block name="ESHM" comment="is the shower max section"  >
            <Material name="ECAL_Air"  />
            <Attribute for="ESHM" seen="1" colo="4"  />
            <Shape type="CONS" rmn1="(zslice*tan_low)-dd" rmn2="(zslice+zwidth)*tan_low-dd" rmx2="(zslice+zwidth)*tan_upp+dup" rmx1="(zslice)*tan_upp+dup" dz="zwidth/2" phi2="emcs_phimax" phi1="emcs_phimin"  />
            <Use struct="EMXG"  />
            maxcnt = emcs_smdcentr 
            <Print level="1" fmt="' === z start for smd,section: ',3f12.4, ' === '"  >
                zslice,section,center 
            </Print>
            
            <Do var="j_section" from="1" to="3"  >
                <Use struct="EXSE" select="jsect" value="j_section "  />
                current = exse_zshift 
                secwid  = emxg_sapex + 2.*emxg_f4 
                section = maxcnt + exse_zshift 
                <Print level="1" fmt="' layer, z, width : ',i3,3f12.4"  >
                    j_section,current,section,secwid 
                </Print>
                
                rbot=section*tan_low 
                rtop=section*tan_upp 
                <Print level="1" fmt="' layer, rbot,rtop : ',i3,2f12.4"  >
                    j_section,rbot,rtop 
                </Print>
                
                <Print level="1" fmt="' smd layer=',I1,' z=',F12.4"  >
                    j_section,center+current 
                </Print>
                
                <Create block="ESPL"  />
                <Placement z="current" konly="'MANY'" block="ESPL"  >
                </Placement>
                
            </Do>
            
            <Create block="ERSM"  />
            <Do var="i" from="1" to="2"  >
                <Do var="j" from="1" to="5"  >
                    xx = emcs_phimin + j*30 
                    yy = xx*degrad 
                    xc = cos(yy)*emcs_tierod(i) 
                    yc = sin(yy)*emcs_tierod(i) 
                    <Placement y="YC" x="XC" z="0" block="ERSM"  >
                    </Placement>
                    
                </Do>
                
            </Do>
            
        </Block>
        


        <Block name="ECGH" comment="is air gap between endcap half wheels"  >
            <Material name="ECAL_Air"  />
            <Attribute for="ECGH" seen="0" colo="7"  />
            <Shape type="TRD1" dz="(emcs_zend-emcs_zorg)/2" dx2="emcs_zend*tan_upp+dup" dx1="emcs_zorg*tan_upp+dup" dy="(emcs_gaphalf+emcs_cover)/2"  />
            rth = emcs_gaphalf + emcs_cover 
            xx=curr*tan_low-d2 
            xleft = sqrt(xx*xx - rth*rth) 
            yy=curr*tan_upp+dup 
            xright = sqrt(yy*yy - rth*rth) 
            secwid = yy - xx 
            xx=curcl*tan_low-d2 
            yleft = sqrt(xx*xx - rth*rth) 
            yy=curcl*tan_upp+dup 
            yright = sqrt(yy*yy - rth*rth) 
            zwidth = yy - xx 
            xx=(xleft+xright)/2 
            yy=(yleft + yright)/2 
            xc = yy - xx 
            length = (xx+yy)/2 
            yc = curcl - curr 
            p = atan(xc/yc)/degrad 
            rth = -(emcs_gaphalf + emcs_cover)/2 
            <Create block="ECHC"  />
            <Placement y="RTH" x="+LENGTH" block="ECHC"  >
            </Placement>
            
            <Placement y="RTH" x="-LENGTH" block="ECHC"  >
                <Rotation alphaz="180"  />
            </Placement>
            
        </Block>
        




        <Block name="ECHC" comment="is steel endcap half cover"  >
            <Material name="ecal_steel"  />
            <Attribute for="ECHC" seen="1" colo="1"  />
            <Shape type="TRAP" tl2="zwidth/2" alp1="0" alp2="0" h2="emcs_cover/2" h1="emcs_cover/2" bl1="secwid/2" tl1="secwid/2" bl2="zwidth/2" phi="0" dz="(curcl-curr)/2" thet="p"  />
        </Block>
        



        <Block name="ESSP" comment="is stainless steel back plate"  >
            <Material name="ecal_steel"  />
            <Attribute for="ESSP" seen="1" colo="6" fill="1"  />
            <Shape type="CONS" rmn1="zslice*tan_low-dd" rmn2="(zslice+zwidth)*tan_low-dd" rmx2="(zslice+zwidth)*tan_upp+dup" rmx1="zslice*tan_upp+dup" dz="emcs_bckplate/2" phi2="emcs_phimax" phi1="emcs_phimin"  />
        </Block>
        




        <Block name="EPSB" comment="IS A PROJECTILE STAINLESS STEEL BAR"  >
            <Material name="Ecal_Steel"  />
            <Attribute for="EPSB" seen="1" colo="6" fill="1"  />
            <Shape type="TRAP" tl2="2.5/2" alp1="0" alp2="0" h2="2.0/2" h1="2.0/2" bl1="2.5/2" tl1="2.5/2" bl2="2.5/2" phi="0" dz="(emcs_zend-emcs_zorg)/2" thet="p"  />
        </Block>
        



        <Block name="ERCM" comment="is stainless steel tie rod in calorimeter sections"  >
            <Material name="Ecal_Steel"  />
            <Attribute for="ERSM" seen="1" colo="6" fill="1"  />
            <Shape type="TUBE" dz="zwidth/2" rmin="0" rmax="emcs_rtie"  />
        </Block>
        


        <Block name="ERSM" comment="is stainless steel tie rod in shower max"  >
            <Material name="Ecal_Steel"  />
            <Attribute for="ERSM" seen="1" colo="6" fill="1"  />
            <Shape type="TUBE" dz="zwidth/2" rmin="0" rmax="emcs_rtie"  />
        </Block>
        


        <Block name="EMOD" comment="(fsect,lsect) IS ONE MODULE OF THE EM ENDCAP"  >
            <Attribute for="EMOD" seen="1" serial="FILLED" colo="3"  />
            <Material name="ECAL_Air"  />
            <Shape type="CONS" rmn1="zslice*tan_low-dd" rmn2="(zslice+zwidth)*tan_low-dd" rmx2="(zslice+zwidth)*tan_upp+dup" rmx1="zslice*tan_upp+dup" dz="zwidth/2" phi2="emcs_phimax/emcs_nsupsec" phi1="emcs_phimin/emcs_nsupsec"  />
            section = zslice 
            curr = zslice + zwidth/2 
            <Do var="i_section" from="fsect" to="lsect"  >

                <Use struct="ESEC" select="isect" value="i_section   "  />
                secwid  = esec_cell*esec_nlayer 
                <If expr="I_SECTION==3|I_SECTION==5"  >
                    secwid  = secwid - radiator 
                    <Elif expr="I_SECTION==4"  >
                        secwid  = secwid - esec_cell + radiator 
                    </Elif>
                    
                </If>
                
                <Print level="1" fmt="'+ ECVO isection=',I1,' zcenter=', F12.4"  >
                    i_section,section-curr+secwid/2 
                </Print>
                
                <Create block="ESEC"  />
                <Placement z="section-curr+secwid/2" block="ESEC"  >
                </Placement>
                
                section = section + secwid 
            </Do>
            
        </Block>
        


        <Block name="ESEC" comment="is a single em section"  >

            <Material name="ECAL_Air"  />
            <Attribute for="ESEC" seen="1" serial="filled" lsty="2" colo="1"  />
            <Shape type="CONS" rmn1="(section)*tan_low-dd" rmn2="(section+secwid)*tan_low-dd" rmx2="(section+secwid)*tan_upp+dup" rmx1="(section)*tan_upp+dup" dz="secwid/2"  />
            length = -secwid/2 
            current = section 
            megatile = esec_scint+emcs_alincell+emcs_frplast+emcs_bkplast 
            gap = esec_cell - radiator - megatile 
            <Print level="2" fmt="' ESEC:i_section,section',i3,f12.4"  >
                i_section,section 
            </Print>
            
            <Do var="is" from="1" to="esec_nlayer"  >
                cell  = esec_cell 
                plate = radiator 
                <If expr="is==nint(esec_nlayer) &amp; (i_section==3|i_section==5)"  >
                    cell = megatile + gap 
                    plate=0 
                    <Elif expr="i_section==4&amp;is==1"  >
                        cell = radiator   
                    </Elif>
                    
                </If>
                
                <Print level="2" fmt="' esec:i_section,is,length,cell,current ',2i3,3f12.4"  >
                    i_section,is,length,cell,current 
                </Print>
                
                <If expr="i_section==4&amp;is==1"  >
                    cell = radiator + emcs_slop 
                    <Print level="1" fmt="' + ESEC radiator ilayer=',I2,' z=',F12.4"  >
                        is,current + cell/2+esec_deltaz 
                    </Print>
                    
                    <Create block="ERAD"  />
                    <Placement z="length+(cell)/2+esec_deltaz" block="ERAD"  >
                    </Placement>
                    
                    length  = length + cell 
                    current = current + cell 
                    <Else  >
                        cell = megatile 
                        <If expr="FILLED==1"  >
                            <Create block="EMGT"  />
                            <Placement z="length+(gap+cell)/2+esec_deltaz" block="EMGT"  >
                            </Placement>
                            
                            xx = current + (gap+cell)/2+esec_deltaz 
                            <Print level="2" fmt="' mega i_section,is ',2i3,f10.4"  >
                                i_section,is,xx 
                            </Print>
                            
                            <Print level="1" fmt="' + ESEC megatile ilayer=',I2,' z=',F12.4"  >
                                is,xx 
                            </Print>
                            
                        </If>
                        
                        length  = length  + cell + gap 
                        current = current + cell + gap 
                        <If expr="PLATE&gt;0"  >
                            cell = radiator 
                            <Print level="1" fmt="' + ESEC radiator ilayer=',I2,' z=',F12.4"  >
                                is,current + cell/2+esec_deltaz 
                            </Print>
                            
                            <Create block="ERAD"  />
                            <Placement z="length+cell/2+esec_deltaz" block="ERAD"  >
                            </Placement>
                            
                            length  = length  + cell 
                            current = current + cell 
                        </If>
                        
                    </Else>
                    
                </If>
                
            </Do>
            
        </Block>
        




        <Block name="EMGT" comment="is a 30 degree megatile"  >
            <Material name="ECAL_Air"  />
            <Attribute for="EMGT" seen="1" lsty="2" colo="1"  />
            <Shape type="CONS" rmn1="(current)*tan_low-dd" rmn2="(current+megatile)*tan_low-dd" rmx2="(current+megatile)*tan_upp+dup" rmx1="(current)*tan_upp+dup" dz="megatile/2"  />

            <Par name="CUTGAM" value="0.00001"  />
            <Par name="CUTELE" value="0.00001"  />

        <Export language="Mortran">
            Set EmCuts(EABS) 
        </Export>

            <Do var="isec" from="1" to="nint(emcs_nslices)"  >
                myPhi = (emcs_nslices/2-isec+0.5)*dphi + esec_jiggle(is) 
                <Create block="EPER"  />
                <Placement block="EPER"  >
                    <Rotation alphaz="myPhi"  />
                </Placement>
                
            </Do>
            
        </Block>
        




        <Block name="EPER" comment="is a 5 degree slice of a 30 degree megatile (subsector)"  >
            <Material name="Polystyren"  />
            <Material name="ECAL_Polystyren" isvol="0"  />
            <Attribute for="EPER" seen="1" lsty="1" colo="1"  />
            <Shape type="CONS" rmn1="(current)*tan_low-dd" rmn2="(current+megatile)*tan_low-dd" rmx2="(current+megatile)*tan_upp+dup" rmx1="(current)*tan_upp+dup" dz="megatile/2" phi2="emcs_phimax/emcs_nsector" phi1="emcs_phimin/emcs_nsector"  />
        <Export language="Mortran">
            Set EmCuts(EABS) 
        </Export>
            curcl = current+megatile/2  
            <Do var="ie" from="1" to="nint(eetr_neta)"  >
                etabot  = eetr_etabin(ie) 
                etatop  = eetr_etabin(ie+1) 

                rbot=(curcl)*tanf(etabot) 
                rtop=min((curcl)*tanf(etatop), ((current)*tan_upp+dup)) 
                <Check expr=" rbot&lt;rtop "  />
                xx=tan(pi*emcs_phimax/180.0/emcs_nsector) 
                yy=cos(pi*emcs_phimax/180.0/emcs_nsector) 

                <Create block="ETAR"  />
                <Placement x="(rbot+rtop)/2" block="ETAR"  >
                    <Rotation ort="yzx"  />
                </Placement>
                
                <Print level="2" fmt="' EPER : ie,etatop,etabot,rbot,rtop ',i3,4f12.4"  >
                    ie,etatop,etabot,rbot,rtop 
                </Print>
                
            </Do>
            
        </Block>
        


        <Block name="ETAR" comment="is a single calorimeter cell, containing scintillator, fiber router, etc..."  >
            <Material name="ECAL_POLYSTYREN"  />
            <Attribute for="ETAR" seen="1" lsty="1" colo="4"  />
            <Shape type="TRD1" dz="(rtop-rbot)/2" dx2="rtop*xx-emcs_gapcel/yy" dx1="rbot*xx-emcs_gapcel/yy" dy="megatile/2"  />
            <Create block="EALP"  />
            <Placement y="(-megatile+emcs_alincell)/2" block="EALP"  >
            </Placement>
            
            g10 = esec_scint 
            <Create block="ESCI"  />
            <Placement y="(-megatile+g10)/2+emcs_alincell+emcs_frplast" block="ESCI"  >
            </Placement>
            
        </Block>
        


        <Block name="ESCI" comment="is the active scintillator (polystyrene) layer"  >
            <Material name="Polystyren"  />
            <Material name="Ecal_scint" isvol="1"  />
            <Attribute for="ESCI" seen="1" colo="7" lsty="1" fill="0"  />
            <Shape type="TRD1" dz="(rtop-rbot)/2-emcs_gapcel" dy="esec_scint/2"  />


            <Par name="CUTGAM" value="0.00008"  />
            <Par name="CUTELE" value="0.001"  />
            <Par name="BCUTE" value="0.0001"  />
            <Par name="CUTNEU" value="0.001"  />
            <Par name="CUTHAD" value="0.001"  />
            <Par name="CUTMUO" value="0.001"  />
        <Export language="Mortran">
            Set EmCuts (ESEN) 
        </Export>
            <Par name="BIRK1" value="1."  />
            <Par name="BIRK2" value="0.013"  />
            <Par name="BIRK3" value="9.6E-6"  />
            <Instrument block="ESCI">
                 <Hit meas="birk" nbits="0" min="0" max="10" />
            </Instrument>
        </Block>
        


        <Block name="ERAD" comment="is the lead radiator with stainless steel cladding"  >
            <Material name="ECAL_STEEL"  />
            <Attribute for="ERAD" seen="1" colo="6" lsty="1" fill="1"  />
            <Shape type="CONS" rmn1="(current)*tan_low-dd" rmn2="(current+cell)*tan_low-dd" rmx2="(current+radiator)*tan_upp+dup" rmx1="(current)*tan_upp+dup" dz="radiator/2"  />
            <Create block="ELED"  />
            <Placement block="ELED"  >
            </Placement>
            
        </Block>
        


        <Block name="ELED" comment="is a lead absorber plate"  >
            <Mixture name="ECAL_PbAlloy" dens="11.35"  >
                <Component name="Sn" a="118.710" z="50" w="0.014"  />
                <Component name="Ca" a="40.0780" z="20" w="0.00075"  />
                <Component name="Al" a="26.9815" z="13" w="0.0003"  />
                <Component name="Pb" a="207.190" z="82" w="0.98495"  />
            </Mixture>
            
            <Attribute for="ELED" seen="1" colo="4" lsty="1" fill="1"  />
            <Shape type="TUBS" dz="emcs_pbplate/2" rmin="(current)*tan_low" rmax="(current+emcs_pbplate)*tan_upp"  />

            <Par name="CUTGAM" value="0.00008"  />
            <Par name="CUTELE" value="0.001"  />
            <Par name="BCUTE" value="0.0001"  />
            <Par name="CUTNEU" value="0.001"  />
            <Par name="CUTHAD" value="0.001"  />
            <Par name="CUTMUO" value="0.001"  />
        <Export language="Mortran">
            Set EmCuts(EABS) 
        </Export>

        </Block>
        


        <Block name="EFLP" comment="is the aluminum (aluminium) front plate of the endcap"  >
            <Material name="ALUMINIUM"  />
            <Material name="ECAL_ALUMINIUM" isvol="0"  />
            <Attribute for="EFLP" seen="1" colo="3" lsty="1" fill="1"  />
            <Shape type="CONS" rmn1="68.813" rmn2="68.813" 
                   rmx2="(zslice+zwidth)*tan_upp+dup" rmx1="(zslice)*tan_upp+dup"
                   dz="emcs_front/2"                  phi2="emcs_phimax" 
                   phi1="emcs_phimin"  />
        <Export language="Mortran">            
            Set EmCuts(EABS) 
        </Export>

        </Block>
        

        <Block name="EALP" comment="is the thin aluminium plate in calorimeter cell"  >
            <Material name="Aluminium"  />
            <Material name="ECAL_AluPlate" isvol="0"  />
            <Attribute for="EALP" seen="1" lsty="1" colo="1"  />
            <Shape type="TRD1" dz="(rtop-rbot)/2" dy="emcs_alincell/2"  />
            <Par name="CUTGAM" value="0.00001"  />
            <Par name="CUTELE" value="0.00001"  />
            <Par name="LOSS" value="1."  />
            <Par name="STRA" value="1."  />
        <Export language="Mortran">
            Set EmCuts(EABS) 
        </Export>

        </Block>
        





        <Block name="ESPL" comment="is the logical volume containing an SMD plane"  >
            <Material name="ECAL_Air"  />
            <Attribute for="ESPL" seen="1" lsty="4" colo="4"  />
            <Shape type="TUBS" rmin="section*tan_low-1.526" rmax="(section-secwid/2)*tan_upp+dup" dz="emcs_gapsmd/3/2" phi2="emcs_phimax" phi1="emcs_phimin"  />
            <Use struct="EMXG" select="version" value="1 "  />
            msecwd = (emxg_sapex+emxg_f4)/2            
            <Do var="isec" from="1" to="6"  >
                cut=1 
                d3 = 75 - (isec-1)*30 
                <If expr="exse_sectype(isec)==0|(emcg_fillmode==1&amp;(isec==6|isec==1))"  >
                    cut = 0 
                    <Elif expr="exse_sectype(isec)==1"  >
                        <Create block="EXSG"  />
                        <Placement ncopy="isec" konly="'MANY'" block="EXSG"  >
                            <Rotation alphaz="d3"  />
                        </Placement>
                        
                        <Elif expr="exse_sectype(isec)==2"  >
                            <Create block="EXSG"  />
                            <Placement ncopy="isec" konly="'MANY'" block="EXSG"  >
                                <Rotation alphaz="d3"  />
                                <Rotation ort="x-y-z"  />
                            </Placement>
                            
                            <Elif expr="exse_sectype(isec)==3"  >
                                cut=2 
                                <Create block="EXSG"  />
                                <Placement ncopy="isec" konly="'MANY'" block="EXSG"  >
                                    <Rotation alphaz="d3"  />
                                </Placement>
                                
                                <Elif expr="exse_sectype(isec)==4"  >
                                    cut=2 
                                    <Create block="EXSG"  />
                                    <Placement ncopy="isec" konly="'MANY'" block="EXSG"  >
                                        <Rotation alphaz="d3"  />
                                        <Rotation ort="x-y-z"  />
                                    </Placement>
                                    
                                </Elif>
                                
                            </Elif>
                            
                        </Elif>
                        
                    </Elif>
                    
                </If>
                
            </Do>
            
            <Do var="isec" from="1" to="6"  >
                d3=75 - (isec-1)*30 
                <If expr="exse_sectype(isec)==0|(emcg_fillmode==1&amp;(isec==6|isec==1))"  >
                    cut = 0          
                    <Create block="EXSG"  />
                    <Placement ncopy="isec" konly="'MANY'" block="EXSG"  >
                        <Rotation alphaz="d3"  />
                    </Placement>
                    
                </If>
                
            </Do>
            
        </Block>
        


        <Block name="EXSG" comment="Is another logical volume... this one acutally creates the planes"  >

            <Attribute for="EXSG" seen="1" serial="cut" lsty="3" colo="7"  />
            <Material name="ECAL_Air"  />
            <Shape type="TUBS" rmin="section*tan_low-1.526" rmax="(section-secwid/2)*tan_upp+dup" dz="emcs_gapsmd/3/2" phi2="emcs_phimax/emcs_nsupsec+5" phi1="emcs_phimin/emcs_nsupsec-5"  />
            rbot = emxg_rin 
            rtop = emxg_rout 
            <If expr="cut.eq.0"  >
                <Create block="EXPS"  />
                <Placement konly="'MANY'" block="EXPS"  >
                </Placement>
                
            </If>
            
            <If expr="cut&gt;0"  >

                <If expr="cut==1"  >
                    nstr = 288 
                <Else  >
                    nstr = 285 
                </Else>                    
                </If>
                

                <Do var="istrip" from="1" to="nstr"  >

                    <Call routine="ecal_get_strip" expr="section,cut,istrip,xc,yc,length"/>

                    <If expr="mod(istrip,2)!=0"  >

                        <Create block="EHMS"  />
                        <Placement block="EHMS" y="yc" x="xc"><Rotation alphaz="-45"/></Placement> <!-- ONLY is default -->
                        
                        <Create block="EBLS"  />
                        <Placement block="EBLS" y="yc" x="xc" z="(+esmd_apex/2+esmd_back_layer/2)">
                            <Rotation alphaz="-45"  />
                        </Placement>
                        
                    <Else  >
                        <Create block="EHMS"  />
                        <Placement block="EHMS" y="yc" x="xc">
                                <Rotation alphaz="-45"  />
                                <Rotation ort="x-y-z"  />
                        </Placement>
                            
                        <Create block="EFLS"  />
                        <Placement block="EFLS" y="yc" x="xc" z="(-esmd_apex/2-esmd_front_layer/2)">
                                <Rotation alphaz="-45"  />
                                <Rotation ort="x-y-z"  />
                        </Placement>
                            
                    </Else>                     
                    </If>
                    
                </Do>
                
            </If>
            
        </Block>
        

        <Block name="EHMS" comment="defines the triangular SMD strips"  >
            <Material name="Polystyren"  />
            <Material name="ECAL_smdstrip" isvol="1"  />
            <Attribute for="EHMS" seen="1" serial="cut" lsty="1" colo="2"  />
            <Shape type="TRD1" dz="emxg_Sapex/2" dx2="emxg_Sbase/2" dx1="0" dy="length/2"  />

            <Par name="CUTGAM" value="0.00008"  />
            <Par name="CUTELE" value="0.001"  />
            <Par name="BCUTE" value="0.0001"  />
            <Par name="BIRK1" value="1."  />
            <Par name="BIRK2" value="0.0130"  />
            <Par name="BIRK3" value="9.6E-6"  />
        <Export language="Mortran">
            Set EmCuts (ESEN) 
        </Export>

            <Instrument block="EHMS">
                <Hit meas="birk" nbits="0" min="0" max="10" />
            </Instrument>
        </Block>
        



        <Block name="EFLS" comment="is the layer of material on the front of the SMD planes"  >
            <Mixture name="EFLS" dens="(1.19*1.7+0.25*1.53+0.17*1.39)/(1.19+0.25+0.17)"  >
                <Component name="G10" a="18.017" z="9.013" w="1.19*1.700/(1.19*1.700+0.25*1.530+0.17*1.390)"  />
                <Component name="Fiberglass" a="19.103" z="9.549" w="0.25*1.530/(1.19*1.700+0.25*1.530+0.17*1.390)"  />
                <Component name="AlMylar" a="12.889" z="6.465" w="0.17*1.390/(1.19*1.700+0.25*1.530+0.17*1.390)"  />
            </Mixture>
            

            <Attribute for="EFLS" seen="0" lsty="1" colo="22"  />
            <Shape type="TRD1" dz="esmd_front_layer/2" dx2="esmd_base/2" dx1="esmd_base/2" dy="length/2"  />

        <Export language="Mortran">
            Set EmCuts(EABS) 
        </Export>

        </Block>
        




        <Block name="EBLS" comment="is the layer of material on the back of the SMD planes"  >
            <Mixture name="EBLS" dens="(0.10*1.390+0.25*1.530+1.50*1.032+0.25*2.699)/(0.10+0.25+1.50+0.25)"  >
                <Component name="AlMylar" a="12.889" z="6.465" w="0.10*1.390/(0.10*1.390+0.25*1.530+1.50*1.032+0.25*2.699)"  />
                <Component name="Fiberglass" a="19.103" z="9.549" w="0.25*1.530/(0.10*1.390+0.25*1.530+1.50*1.032+0.25*2.699)"  />
                <Component name="Polystyren" a="11.154" z="5.615" w="1.50*1.032/(0.10*1.390+0.25*1.530+1.50*1.032+0.25*2.699)"  />
                <Component name="Al" a="28.08" z="14.00" w="0.25*2.699/(0.10*1.390+0.25*1.530+1.50*1.032+0.25*2.699)"  />
            </Mixture>
            
            <Attribute for="EFLS" seen="0" lsty="1" colo="22"  />
            <Shape type="TRD1" dz="esmd_back_layer/2" dx2="esmd_base/2" dx1="esmd_base/2" dy="length/2"  />

        <Export language="Mortran">
            Set EmCuts(EABS) 
        </Export>

        </Block>
        


        <Block name="EXPS" comment="is the plastic spacer in the shower maximum section"  >
            <Mixture name="PVC_Spacer" dens="1.390*(1.20/1.00)"  >
                <Component name="H" a="1" z="1" w="3.0*1.0/62.453"  />
                <Component name="C" a="12" z="6" w="2.0*12.0/62.453"  />
                <Component name="Cl" a="35.453" z="17" w="1.0*35.453/62.453"  />
            </Mixture>
            

            <Attribute for="EXPS" lwid="2" seen="1" lsty="1" colo="6"  />
            <Shape type="TUBS" rmin="(section)*Tan_Low-1.526" rmax="(section+msecwd)*Tan_Upp" dz="1.0/2" phi2="emcs_PhiMax/emcs_Nsupsec" phi1="emcs_PhiMin/emcs_Nsupsec"  />
        <Export language="Mortran">
            Set EmCuts(EABS) 
        </Export>

        </Block>
        
    </Module>

    <Subroutine  name="ecal_get_strip"
                 args="['section', 'cut', 'istrip', 'xcenter', 'ycenter', 'length']" >

        <Arguement type="real"    intent="inout" name="section" />
        <Arguement type="integer" intent="inout" name="cut"     />
        <Arguement type="integer" intent="inout" name="istrip"  />
        <Arguement type="real"    intent="inout" name="xcenter" />
        <Arguement type="real"    intent="inout" name="ycenter" />
        <Arguement type="real"    intent="inout" name="length"  />
 
        <CDE>gcunit,agecom</CDE>
        
        <varlist type="INTEGER"  >
            nstrips
        </varlist>
        
        <varlist type="REAL"  >
            rdel,rth,ddn,ddup,megatile,p,xleft,yleft,xright,yright,dxy,xx,yy,sqrt2,sqrt3
        </varlist>
        
        <varlist type="REAL"  >
            base/1.0/ 
        </varlist>
        
        <varlist type="REAL"  >
            Rbot/77.41/,Rtop/213.922/
        </varlist>
        
        <!-- varlist type="REAL"  >
            EtaMin/1.086/,EtaMax/2.000/  ! not used
        </varlist -->
        
        <varlist type="REAL"  >
        <!-- tan_theta_min/0.275720567/ ! not needed -->
             tan_theta_max/0.761952162/
        </varlist>

<Export language="Mortran">        
        <Inline name="tanf" type="real"> 
        	<Arguement type="real" name="etax" />
        	<Return value="tan(2*atan(exp(-etax)))" />
        </Inline>   
</Export>
<!--        
        tan_theta_min = tanf( EtaMax ) 
        tan_theta_max = tanf( EtaMin ) 
-->


        <If expr="cut .eq. 1"  >
            rdel    = 3.938                                                                                                          
            nstrips = 288                                                                                                            
        <Else  >
            rdel    = -.475                                                                                                          
            nstrips = 285                                                                                                            
        </Else>            
        </If>
        
        xcenter=0.  
        ycenter=0. 
        length=0. 
        <If expr="cut==0"  >
            return
        </If>
        
        sqrt2 = sqrt(2.0) 
        sqrt3 = sqrt(3.0) 
        rth = .53*rdel        ! .53 --- tentatavily    jcw-- wtf?                                                                
        ddn = sqrt(3.0)*1.713 + rdel                                                                                                   
        ddup = .5*1.846 + 1.713              
        megatile = base + .01 
        p = .5*(istrip-1)*megatile + 41.3655   

        <If expr="p&lt;=(.5*rbot*sqrt3+rth)"  >

            dxy     = 1.9375*sqrt2 
            xleft  = .5*sqrt2*p*(sqrt3 + 1.) - dxy 
            yleft  = .5*sqrt2*p*(sqrt3 - 1.) - dxy  
            yright = .5*sqrt2*(sqrt( rbot*rbot - p*p) - p) 
            xright = sqrt2*p + yright 


        <Elif expr="(.5*rbot*sqrt3+rth)&lt;p .and. p &lt;=(.5*rtop+1.5)"  >

            dxy = 1.9375*sqrt2 
            xleft = .5*sqrt2*p*(sqrt3 + 1.) - dxy 
            yleft = .5*sqrt2*p*(sqrt3 - 1.) - dxy  
            dxy = rdel*sqrt2/sqrt3 
            yright = .5*sqrt2*p*(1.- 1./sqrt3) 
            xright = sqrt2*p - yright - dxy 
            yright = -yright - dxy 

        <Elif expr="p&gt;(.5*rtop+1.5)"  >

            yleft = (sqrt(rtop*rtop - p*p) - p)/sqrt2 
            xleft = sqrt2*p + yleft 
            dxy = rdel*sqrt2/sqrt3 
            yright = .5*sqrt2*p*(1.- 1./sqrt3) 
            xright = sqrt2*p - yright - dxy 
            yright = -yright - dxy 
            dxy = 0.  


                    <If expr="(.5*sqrt3*160.-ddn)&lt;p .and. p &lt;=(.5*sqrt3*160.+ddup)"  >
                        xcenter = .5*(sqrt3*160.+1.846) 
                        ycenter = xcenter - .5*sqrt3*1.713 
                        <If expr="p&gt;ycenter"  >
                            dxy = .5*sqrt2*(2/sqrt3*rdel + .5*sqrt3*1.846 + sqrt(1.713*1.713 - (p-xcenter)*(p-xcenter))) 
                        <Else  >
                            dxy = sqrt2/sqrt3*(p - .5*sqrt3* 160. + ddn) 
                        </Else>                            
                        </If>
                        
                    <Elif expr="(.5*sqrt3*195.-ddn)&lt;p .and. p &lt;=(.5*sqrt3*195.+ddup)"  >
                         xcenter = .5*(sqrt3*195.+1.846) 
                         ycenter = xcenter - .5*sqrt3*1.713 

                            <If expr="p&gt;ycenter"  >
                                dxy = .5*sqrt2*(2/sqrt3*rdel + .5*sqrt3*1.846 + sqrt(1.713*1.713 - (p-xcenter)*(p-xcenter))) 
                            <Else  >
                                dxy = sqrt2/sqrt3*(p - .5*sqrt3*195. + ddn) 
                            </Else>                                
                            </If>
                            
                    </Elif>                       
                    </If>
                    
            xright = xright + dxy 
            yright = yright + dxy 
            </Elif>                
            </Elif>
            
        </If>
        

        dxy     =  section*tan_theta_max - rtop  
        xcenter = .5*(xright+xleft) + dxy        
        ycenter = .5*(yright+yleft)              
        xx = .5*sqrt2*(xleft+yleft)              
        yy = .5*sqrt2*(xright+yright)            
        length = xx-yy                               

        return

    </Subroutine>
    





</Document>

