<Document file="StarVMC/Geometry/FpdmGeo/FpdmGeo4.xml">
<Module name="FPDMGEO4" comment=" is the Forward Pion Detector Modules GEOmetry "  >

  <Created date="   27 Nov 2006 "  />
  <Author name="Akio Ogawa"  />
  <CDE  >
    AGECOM
    GCONST
    GCUNIT
  </CDE>
        
  <Content  >
    FBOX,FTOW,FLXF,FWAL,FLGR,FPCT,FUMT,
    PBPT,FSHM,FHMS,FXGT,FALU,FBAS,FENC,
    FEAC,FEBC,FECC,FEDC,FETC,FERC,FESC, 
    FEEC,FPRS,FPLY,FPPB,FPSC,FPBB,
    FLIG,FLBA,FLCO,FPMT,FFEE,
    FLLG,FBLL,FCLL,
    WPPL,WPIS,WPUF,WPUN,WPUS,WPAR
  </Content>
  
  <Structure name="FMCG"   >
    <var name="Version"   />
    <var name="ChkvSim"   />
    <var name="PbPlate"   />    
    <var name="FmsNorthX" />
    <var name="FmsSouthX" />
    <var name="Atten" />    
  </Structure>
        
  <Structure name="FPOS"  >
    <var name="iMod"  type="float"  />
    <var name="iType" type="float"  />
    <var name="X"     type="float"  />
    <var name="Y"     type="float"  />
    <var name="Z"     type="float"  />
    <var name="AY"    type="float"  />
    <var name="AZ"    type="float"  />
  </Structure>
        
  <Structure name="FBXD"  >
    <var name="Type" type="float"  />
    <var name="Height" type="float"  />
    <var name="Depth" type="float"  />
    <var name="Width" type="float"  />
    <var name="NX" type="float"  />
    <var name="NY" type="float"  />
    <var name="NXL" type="float"  />
    <var name="NYL" type="float"  />
    <var name="XOffset" type="float"  />
    <var name="ZOffset" type="float"  />
    <var name="PSOffset" type="float"  />
    <var name="SmdOff" type="float"  />
  </Structure>
        
  <Structure name="FLGG"  >
    <var name="Type" type="float"  />
    <var name="Width" type="float"  />
    <var name="Depth" type="float"  />
    <var name="DGap" type="float"  />
    <var name="AlThick" type="float"  />
    <var name="PhCathDz" type="float"  />
    <var name="PhCathR" type="float"  />
    <var name="MuMetDz" type="float"  />
    <var name="MuMetR" type="float"  />
  </Structure>
  
  <Structure name="FLGM"  >
    <var name="Type" type="float"  />
    <var name="Density" type="float"  />
    <var name="RadLen" type="float"  />
    <var name="PbCont" type="float"  />
    <var name="CritEne" type="float"  />
    <var name="MoliereR" type="float"  />
  </Structure>
  
  <Structure name="PBPD"  >
    <var name="Z" type="float"  />
    <var name="Width" type="float"  />
    <var name="Height" type="float"  />
    <var name="Thick" type="float"  />
  </Structure>
  
  <Structure name="FMXG"  >
    <var name="Version" type="float"  />
    <var name="Sapex" type="float"  />
    <var name="Sbase" type="float"  />
    <var name="Sgap" type="float"  />
    <var name="NStrip" type="float"  />
    <var name="G10Width" type="float"  />
    <var name="G10hgt" type="float"  />
    <var name="G10Thick" type="float"  />
  </Structure>
  
  <Structure name="INSE"  >
    <var name="Width" type="float"  />
    <var name="Depth" type="float"  />
    <var name="Height" type="float"  />
    <var name="SheetDpt" type="float"  />
    <var name="HoleGap" type="float"  />
    <var name="HoleDepth" type="float"  />
    <var name="HoleHeight" type="float"  />
    <var name="GapDepth" type="float"  />
    <var name="GapHeight" type="float"  />
    <var name="GateDepth" type="float"  />
    <var name="Ra" type="float"  />
    <var name="Rb" type="float"  />
    <var name="Diam" type="float"  />
    <var name="RMax" type="float"  />
    <var name="GateGap" type="float"  />
  </Structure>
  
  <Structure name="PRSW"  > 
    <var name="DBox(3)"  type="float"  />
    <var name="Xoff(4)"  type="float"  />
    <var name="Yoff(4)"  type="float"  />
    <var name="Zoff(4)"  type="float"  />
    <var name="Dz(4)"    type="float"  />
    <var name="DHole"    type="float"  />
    <var name="NType"    type="integer" />
    <var name="NPrs(2)"  type="integer" />
    <var name="DPrs(3)"  type="real" />
    <var name="NSkipV"   type="integer" />
    <var name="NSkipH"   type="integer" />
    <var name="DyCut"    type="real" />
    <var name="DLG(3)"   type="real" />
    <var name="DSIPM(4)" type="real" />
    <var name="DzBbd(4)" type="real" />
    <var name="DxBbd(2)" type="real" />
  </Structure>

  <Structure name="WPFM"  >
    <var name="PoleD(4)" type="float"  />
    <var name="PoleP(3)" type="float"  />
    <var name="IstrD(4)" type="float"  />
    <var name="Ist1P(3)" type="float"  />
    <var name="Ist2P(3)" type="float"  />
    <var name="UstFD(4)" type="float"  />
    <var name="UstFP(3)" type="float"  />
    <var name="UstND(4)" type="float"  />
    <var name="UstNP(3)" type="float"  />
    <var name="UstSD(4)" type="float"  />
    <var name="UstSP(3)" type="float"  />
  </Structure>

  <varlist type="INTEGER"  >
    ChkvSim,iMod,iType,Type,PbPlate
  </varlist>
  
  <varlist type="INTEGER"  >
    i,j,k,kk,m,serN,lr,tb,col,kmod,rot,id,layr,quad,slat(4,3)
    debug,npstype,pstype(20),cpstype(20),flag
  </varlist>

  <varlist type="REAL"  >
    xx,yy,zz,x1,y1,z1,ztot,rtot,wid,widx,widy,bwid,x0,widL,dx,dy,dz,dxx,dyy,dzz,xxx,yyy,dxxx,dyyy,xpmt,ypmt
    dx1,dy1,dz1,dx2,dy2,dz2,x2,y2,z2,dz3,dx1a,dx1b,dzsb,psdim(20,2)
  </varlist>
  
  <varlist type="REAL">    ztotsmd,wtotsmd,zsmd,zsmd2,wsmd  </varlist>
  <varlist type="REAL"  >  xsmdh,ysmdh,zsmdh,xsmdv,ysmdv,zsmdv  </varlist>
  <varlist type="REAL"  >  xlcOffSet,BZOffSet  </varlist>
  <varlist type="REAL"  >  basewidth,distancer,xoffFECC,xoffFEDC,xshift  </varlist>
  <varlist type="REAL"  >  xoffFENC,yoffFENC,zoffFENC,zoffFECC  </varlist>
  <varlist type="REAL"  >  tmp(7)  </varlist>


  <varlist   type="INTEGER"> N  </varlist>
  <Parameter name="N" value="12" />

  <varlist type="REAL"> E(N)  </varlist>
  <varlist type="REAL"> rindex_PbG(N)  </varlist>
  <varlist type="REAL"> rindex_SiRub(N)  </varlist>
  <varlist type="REAL"> rindex_PhCath(N)  </varlist>
  <varlist type="REAL"> rindex_Alm(N)  </varlist>
  <varlist type="REAL"> rindex_MuMet(N)  </varlist>
  <varlist type="REAL"> absco_PbG(N)  </varlist>
  <varlist type="REAL"> absco_SiRub(N)  </varlist>
  <varlist type="REAL"> absco_PhCath(N)  </varlist>
  <varlist type="REAL"> absco_Alm(N)  </varlist>
  <varlist type="REAL"> absco_MuMet(N)  </varlist>
  <varlist type="REAL"> effic_PhCath(N)  </varlist>
  <varlist type="REAL"> effic_all(N)  </varlist>



  <varlist type="REAL"  >
    lprs1,lprs2,lprs3,lprs4,pwid,x,y,z,dlg
  </varlist>


  <External routine="FFPDSTEP"  />
  <External routine="FPCTSTEP"  />

  <Fill name="FMCG" comment="Fpd Calorimeter basic data"  >
    <var name="Version" value="8.0" comment=" Geometry version  "  />
    <var name="ChkvSim" value="0" comment=" = 0 dE, = 1 Cherenkov simulation for PbG "  />
    <var name="Atten" value="0.0" comment="default, no attenuation, 1 = attenuation" />
    <var name="PbPlate" value="0" comment=" =0 no plate, =1 with plate "  />
    <var name="FmsNorthX" value="-0.3" comment="Default x-position" />
    <var name="FmsSouthX" value="+0.3" comment="Default x-position" />
  </Fill>

  <Use struct="FMCG" select="version" value="8.0" />


  <Fill name="FPOS" comment="Fpd EN positioning"  >
    <var name="iMod" value="1" comment=" Module# (EN=1, ES=2, WN=3, WS=4, ...) "  />
    <var name="iType" value="1" comment=" Type (1=7*7+SMD+PreShower, 2=17*34+14*28) "  />
    <var name="X" value="-48.19" comment=" X distance from beam to edge of detector "  />
    <var name="Y" value="0.0" comment=" Y distance from beam to edge of detector "  />
    <var name="Z" value="-779.0" comment=" Z distance from IP to surface of detector "  />
    <var name="AY" value="180" comment=" Angle aroound Y (0 for west, 180 for east) "  />
    <var name="AZ" value="0" comment=" Angle around Z "  />
  </Fill>

  <Fill name="FPOS" comment="Fpd ES positioning"  >
    <var name="iMod" value="2" comment=" Module# (EN=1, ES=2, WS=3, WS=4, ...) "  />
    <var name="iType" value="1" comment=" Type (1=7*7+SMD+PreShower, 2=17*34+14*28) "  />
    <var name="X" value="48.19" comment=" X distance from beam to edge of detector "  />
    <var name="Y" value="0.0" comment=" Y distance from beam to edge of detector "  />
    <var name="Z" value="-779.0" comment=" Z distance from IP to surface of detector "  />
    <var name="AY" value="180" comment=" Angle aroound Y (0 for west, 180 for east) "  />
    <var name="AZ" value="0" comment=" Angle around Z "  />
  </Fill>


  <Fill name="FPOS" comment="FMS WN positioning"  >
    <var name="iMod"  value="3" comment=" Module# (EN=1, ES=2, WN=3, WS=4, ...) "  />
    <var name="iType" value="2" comment=" Type (1=7*7+SMD+PreShower, 2=17*34+14*28) "  />
    <var name="X"     value="FMCG_FmsNorthX" comment=" X distance from beam to edge of detector "  />
    <var name="Y"     value="0.0" comment=" Y distance from beam to edge of detector "  />
    <var name="Z"     value="706.3" comment=" Z distance from IP to surface of detector "  />
    <var name="AY"    value="0" comment=" Angle aroound Y (0 for west, 180 for east) "  />
  </Fill>


  <Fill name="FPOS" comment="FMS WS positioning"  >
    <var name="iMod"  value="4" comment=" Module# (EN=1, ES=2, WN=3, WS=4, ...) "  />
    <var name="iType" value="2" comment=" Type (1=7*7+SMD+PreShower, 2=17*34+14*28) "  />
    <var name="X"     value="FMCG_FmsSouthX" comment=" X distance from beam to edge of detector "  />
    <var name="Y"     value="0.0" comment=" Y distance from beam to edge of detector "  />
    <var name="Z"     value="706.3" comment=" Z distance from IP to surface of detector "  />
    <var name="AY"    value="0" comment=" Angle aroound Y (0 for west, 180 for east) "  />
    <var name="AZ"    value="0" comment=" Angle around Z "  />
  </Fill>

  <Fill name="FBXD" comment="FPD Box Geometry"  >
    <var name="Type" value="1" comment=" Type (1=7*7+SMD+PreShower, 2=17*34+14*28) "  />
    <var name="Height" value="100" comment=" Box height "  />
    <var name="Depth" value="96" comment=" Box Depth "  />
    <var name="Width" value="0.0" comment=" Box Width (only for FMS) "  />
    <var name="NX" value="7" comment=" Number of pbg in x "  />
    <var name="NY" value="7" comment=" number of pbg in y "  />
    <var name="NXL" value="0" comment=" Number of large pbg in x "  />
    <var name="NYL" value="0" comment=" number of large pbg in y "  />
    <var name="XOffset" value="2.54" comment=" tower x offset from box edge to PbG edge "  />
    <var name="ZOffset" value="19" comment=" tower z offset from box edge to PbG edge       "  />
    <var name="PSOffset" value="2.0" comment=" PreShower z offset from box edge to PbG edge "  />
    <var name="SmdOff" value="8.0" comment=" SMD V-plane z offset from box edge "  />
  </Fill>


  <Fill name="FBXD" comment="FPD Box Geometry"  >
    <var name="Type" value="2" comment=" Type (1=7*7+SMD+PreShower, 2=17*34+14*28) "  />
    <var name="Height" value="212" comment=" Box height "  />
    <var name="Depth" value="98.425" comment=" Box Depth "  />
    <var name="Width" value="127.0" comment=" Box Width (only for FMS) "  />
    <var name="NX" value="12" comment=" Number of pbg in x "  />
    <var name="NY" value="24" comment=" number of pbg in y "  />
    <var name="NXL" value="17" comment=" Number of large pbg in x "  />
    <var name="NYL" value="34" comment=" number of large pbg in y "  />
    <var name="XOffset" value="(6*3.822+0.5*5.812)+(127.0-17*5.812)/2.0" comment=" tower x offset from box edge to PbG edge "  />
    <var name="ZOffset" value="10.4" comment=" tower z offset from box edge to PbG edge "  />
    <var name="PSOffset" value="0" comment=" PreShower z offset from box edge to PbG edge "  />
    <var name="SmdOff" value="0.0" comment=" SMD z offset from box edge "  />
  </Fill>



  <Fill name="FLGG" comment="PbG detector geometry"  >
    <var name="Type" value="1" comment=" Type (1=Protovino Cell, 2=FLab Cell) "  />
    <var name="Width" value="3.81" comment=" PbG width  "  />
    <var name="Depth" value="45.0" comment=" PbG depth "  />
    <var name="DGap" value="0.01" comment=" Gap between PbG "  />
    <var name="AlThick" value="0.001" comment=" almunim wrap thickness (real) "  />
    <var name="PhCathDz" value="2.0" comment=" Photo Cathode thickness "  />
    <var name="PhCathR" value="1.8" comment=" Photo Cathode radius  (real) "  />
    <var name="MuMetDz" value="11.0" comment=" Mu Metal Length "  />
    <var name="MuMetR" value="1.9" comment=" Mu metal outer Radius  (real) "  />
  </Fill>

  <Fill name="FLGG" comment="PbG detector geometry"  >
    <var name="Type" value="2" comment=" Type (1=Protovino Cell, 2=FLab Cell) "  />
    <var name="Width" value="5.8" comment=" PbG width  "  />
    <var name="Depth" value="60.2" comment=" PbG depth "  />
    <var name="DGap" value="0.01" comment=" Gap between PbG "  />
    <var name="AlThick" value="0.001" comment=" almunim wrap thickness (real) "  />
    <var name="PhCathDz" value="2.0" comment=" Photo Cathode thickness "  />
    <var name="PhCathR" value="1.8" comment=" Photo Cathode radius  (real) "  />
    <var name="MuMetDz" value="11.0" comment=" Mu Metal Length "  />
    <var name="MuMetR" value="1.9" comment=" Mu metal outer Radius  (real) "  />
  </Fill>

  <Fill name="FLGM" comment="PbG detector materials"  >
    <var name="Type" value="1" comment=" Type (1=Protovino Cell, 2=FLab Cell) "  />
    <var name="Density" value="3.86" comment=" gdensity [/cm^3] "  />
    <var name="RadLen" value="2.5" comment=" radiation length [cm] "  />
    <var name="PbCont" value="65.4" comment=" PbO content [%] "  />
    <var name="CritEne" value="0.0158" comment=" critical energy [GeV] "  />
    <var name="MoliereR" value="3.32" comment=" Moliere radius [cm] "  />
  </Fill>

  <Fill name="FLGM" comment="PbG detector materials"  >
    <var name="Type" value="2" comment=" Type (1=Protovino Cell, 2=FLab Cell) "  />
    <var name="Density" value="3.61" comment=" gdensity [/cm^3] "  />
    <var name="RadLen" value="3.21" comment=" radiation length [cm] "  />
    <var name="PbCont" value="45.0" comment=" PbO content [%] "  />
  </Fill>

  <Fill name="PBPD" comment="Pb Plate dimensions"  >
    <var name="Width" value="33.02" comment=" Width "  />
    <var name="Height" value="33.02" comment=" Height "  />
    <var name="Thick" value="1.27" comment=" Thickness "  />
  </Fill>

  <Fill name="FMXG" comment="SMD geometry"  >
    <var name="Version" value="2" comment=" Geometry version "  />
    <var name="Sapex" value="0.7" comment=" Scintillator strip apex "  />
    <var name="Sbase" value="1.0" comment=" Scintillator strip base "  />
    <var name="Sgap" value="0.0064" comment=" Gap between strips "  />
    <var name="NStrip" value="50" comment=" # of strips "  />
    <var name="G10Width" value="27.0" comment=" G10 plate width "  />
    <var name="G10hgt" value="27.0" comment=" G10 plate height "  />
    <var name="G10Thick" value="0.15" comment=" G10 plate thickness "  />
  </Fill>

  <Fill name="INSE" comment="INSERT geometry"  >
    <var name="Width" value="19.30908" comment=" Width of the insert (x) "  />
    <var name="Depth" value="98.425" comment=" Depth of the insert (z) "  />
    <var name="Height" value="38.608" comment=" Height of the insert (y)   "  />
    <var name="SheetDpt" value="1.27" comment=" Depth of the steel parts (x,y) "  />
    <var name="HoleGap" value="5.08" comment=" Distance between edge of INSERT and square hole "  />
    <var name="HoleDepth" value="25.4" comment=" Depth of the square hole (z) "  />
    <var name="HoleHeight" value="30.48" comment=" Height of the square hole (y) "  />
    <var name="GapDepth" value="19.685" comment=" Depth of the iron distancer (z) "  />
    <var name="GapHeight" value="7.874" comment=" Height of the iron distancer (y) "  />
    <var name="GateDepth" value="1.905" comment=" Depth of one of the three Gates (z) "  />
    <var name="GateGap" value="12.7" comment=" Distance between the back edge of the box and last gate "  />
    <var name="Ra" value="13.97" comment=" Radius of the inner circle of tubes "  />
    <var name="Rb" value="20.6375" comment=" Radius of the outer circle of tubes  "  />
    <var name="Diam" value="6.0325" comment=" Diameter of the tubes "  />
    <var name="RMax" value="10.16" comment=" Radius of the inner tube for beampipe "  />
  </Fill>

  <Fill name="PRSW" comment="Pre Shower geometry" >
    <var name="DBox"    value="{225.0,250,22.0}"  />
    <var name="Xoff"    value="{ 1.0,1.0,1.0,1.0}"  />
    <var name="Yoff"    value="{ 0.0,0.0,0.0,0.0}"  />
    <var name="Zoff"    value="{675.64,678.52,690.29,692.22}"  />
    <var name="Dz"      value="{1.0,1.0,0.635,1.0}"  />
    <var name="DHole"   value="20.25"  /> 
    <var name="NType"   value="2"  />
    <var name="NPrs"    value="{12,9}"  /> 
    <var name="DPrs"    value="{4.0,5.8,0.05}"  />    ! 1=narrow, 2=wide, 3=gap 
    <var name="NSkipV"  value="2" />  
    <var name="NSkipH"  value="2" />
    <var name="DyCut"   value="3.0+5.8" />            ! virtical bottom will be shorter due to constrain from floor
    <var name="DLG"     value="{0.3,6.0,1.0}"  />     ! 1=size of SiPM, 2=height for cone, 3=height for base
    <var name="DSIPM"   value="{0.5,3.5,1.0,7.0}"  /> ! 1=thickness for board, 2=width, 3=length, 4=length for FEE board
    <var name="DzBbd"   value="{2.54/8.0,2.54/4.0,2*2.54/4.0,2.54/4.0}" /> ! dz(thickness) of back board
    <var name="DxBbd"   value="{2.54, 2.54+7.0}" />   ! backboard 1=inside extend, 2=outside extend
  </Fill>

  <Fill name="WPFM" comment="West Platform geometry">
    <var name="PoleD" value="{12.0*2.54, 155.5 * 2.54, 12.0*2.54, 1.0}"  />
    <var name="PoleP" value="{72.0*2.54, (-44.36-10-155.5/2)*2.54, 807.72-27*2.54}"  />
    <var name="IstrD" value="{231.0*2.54, 8.0*2.54, 8.0*2.54, 1.0}"  />
    <var name="Ist1P" value="{-8.0*2.54, (-44.36-5.0)*2.54, 807.72-37*2.54}"  />
    <var name="Ist2P" value="{-8.0*2.54, (-44.36-5.0)*2.54, 807.72-17*2.54}"  />
    <var name="UstFD" value="{236.0*2.54, 12*2.54, 4*2.54, 1.0}"  />
    <var name="UstFP" value="{-8.0*2.54, -44.36*2.54, 807.72-(46-2)*2.54}"  />
    <var name="UstND" value="{4*2.54, 12.0*2.54, (46-4)*2.54, 1.0}"  />
    <var name="UstNP" value="{-(118-2+8)*2.54, -44.36*2.54, 807.72-(46-4)*2.54/2}"  />
    <var name="UstSD" value="{4*2.54, 12.0*2.54, (46-4)*2.54, 1.0}"  />
    <var name="UstSP" value="{+(118-2-8)*2.54, -44.36*2.54, 807.72-(46-4)*2.54/2}"  />
  </Fill>

  <Use struct="FMCG"  />

  <Print level="1" fmt="'****************** FPDMGEO version ', F4.2"  >
    fmcg_version
  </Print>

  <Do var="m" from="1" to="4"  >

    <Use struct="FPOS" select="iMod" value="m "  />
    <Use struct="FBXD" select="Type" value="FPOS_iType "  />

    <If expr="FBXD_Type.eq.1"  >
      <Use struct="FLGG" select="Type" value="1 "  />
      wid  =  FLGG_Width + FLGG_DGap + FLGG_AlThick*2.0 
      ztot = (FLGG_Depth + FLGG_AlThick + FLGG_MuMetDz)/2.0 
      rtot = FBXD_NX*wid/2.0         
      bwid = rtot+FBXD_XOffset 
      <Else  >
	<Use struct="FLGG" select="Type" value="2 "  />
	wid  =  FLGG_Width + FLGG_DGap + FLGG_AlThick*2.0 
	ztot = (FLGG_Depth + FLGG_AlThick + FLGG_MuMetDz)/2.0 
	rtot = FBXD_NXL*wid/2.0         
	bwid = rtot 
      </Else>

    </If>


    <If expr="m.ge.3"  >
      bwid=FBXD_Width/2.0  
      <If expr="FPOS_X.gt.0.0"  >
	xx=FPOS_X+bwid  
	<Elif expr="FPOS_X.eq.0.0"  >
	  xx=0.0 
	</Elif>

	<Else  >
	  xx=FPOS_X-bwid 
	</Else>

      </If>

      <Else  >
	<If expr="FPOS_X.gt.0.0"  >
	  xx=FPOS_X+bwid 
	  <Elif expr="FPOS_X.eq.0.0"  >
	    xx=0.0 
	  </Elif>

	  <Else  >
	    xx=FPOS_X-bwid 
	  </Else>

	</If>

      </Else>

    </If>


    <If expr="FPOS_Y.gt.0.0"  >
      yy=FPOS_Y+FBXD_Height/2.0 
      <Elif expr="FPOS_Y.eq.0.0"  >
	yy=0.0 
      </Elif>

      <Else  >
	yy=FPOS_Y-FBXD_Height/2.0 
      </Else>

    </If>


    <If expr="FPOS_Z.gt.0.0"  >
      zz=FPOS_Z+FBXD_Depth/2.0 
      <Else  >
	zz=FPOS_Z-FBXD_Depth/2.0 
      </Else>

    </If>


    serN=0 

    <If expr="m.eq.4"  >
      serN=1 
    </If>

    <If expr="m.ne.7"  >
      <Create block="FBOX"  />

      <Placement block="FBOX" in="CAVE" group="WestRefSys" if="zz&gt;0" 		 y="yy" x="xx" z="zz" konly="MANY"  >
	<Rotation alphay="FPOS_AY"  />
      </Placement>

      <Placement block="FBOX" in="CAVE" group="EastRefSys" if="zz&lt;0" 		 y="yy" x="xx" z="zz" konly="MANY"  >
	<Rotation alphay="FPOS_AY"  />
      </Placement>

    </If>

  </Do>



  <Create    block="FPRS"  />
  <Placement block="FPRS" in="CAVE" konly="MANY" group="WestRefSys" 
	     x="0.0" 
	     y="0.0" 
	     z="PRSW_Zoff(1)-PRSW_DSIPM(1)+PRSW_Dbox(3)/2.0" 
	     />

  <Create    block="WPPL"  />
  <Placement block="WPPL" in="CAVE" group="WestRefSys" x="+WPFM_PoleP(1)" y="WPFM_PoleP(2)" z="WPFM_PoleP(3)" />
  <Placement block="WPPL" in="CAVE" group="WestRefSys" x="-WPFM_PoleP(1)" y="WPFM_PoleP(2)" z="WPFM_PoleP(3)" />

  <Create    block="WPIS"  />
  <Placement block="WPIS" in="CAVE" group="WestRefSys" x="WPFM_Ist1P(1)" y="WPFM_Ist1P(2)" z="WPFM_Ist1P(3)" />
  <Placement block="WPIS" in="CAVE" group="WestRefSys" x="WPFM_Ist2P(1)" y="WPFM_Ist2P(2)" z="WPFM_Ist2P(3)" />

  <Create    block="WPUF"  />
  <Placement block="WPUF" in="CAVE" group="WestRefSys" x="+WPFM_UstFP(1)" y="WPFM_UstFP(2)" z="WPFM_UstFP(3)" />
  <Create    block="WPUN"  />
  <Placement block="WPUN" in="CAVE" group="WestRefSys" x="+WPFM_UstNP(1)" y="WPFM_UstNP(2)" z="WPFM_UstNP(3)" />
  <Create    block="WPUS"  />
  <Placement block="WPUS" in="CAVE" group="WestRefSys" x="+WPFM_UstSP(1)" y="WPFM_UstSP(2)" z="WPFM_UstSP(3)" />




  <Block name="FBOX" comment="is one Pb-Glass fpd detector"  >
    <Material name="Air"  />
    <Medium name="standard"  />
    <Attribute for="FBOX" seen="1" serial="serN" colo="2"  />
    <If expr="FBXD_Type.eq.2"  >
      <Shape type="BOX" dz="FBXD_Depth/2.0" dx="FBXD_Width/2.0" dy="FBXD_Height/2.0"  />
    <Else  >
      <Shape type="BOX" dz="FBXD_Depth/2.0" dx="bwid" dy="FBXD_Height/2.0"  />
    </Else>
    </If>


    <Use struct="FLGG" select="Type" value="2 "  />
    widL = FLGG_Width + FLGG_DGap + FLGG_AlThick*2.0              <!-- large cell width  -->
    <Use struct="FLGG" select="Type" value="1 "  />
    <Use struct="FLGM" select="Type" value="1 "  />
    wid  =  FLGG_Width + FLGG_DGap + FLGG_AlThick*2.0             <!-- small cell width -->
    ztot = (FLGG_Depth + FLGG_AlThick + FLGG_MuMetDz)/2.0        
    rtot = FBXD_NX*wid/2.0 
    bwid = rtot-FBXD_XOffset 

    <Create block="FTOW"  />
    <Create block="PBPT"  />
    <Create block="FSHM"  />

    <If expr="FBXD_Type.eq.2.and.FPOS_iMod.eq.4"  >
      x0 = - rtot - FBXD_XOffset + wid/2.0                        <!-- x0 start from north (near beam) for   -->
      widx = wid                                                  <!-- WS (FMS-south) module                 -->
    <Else  >
      x0 =  rtot + FBXD_XOffset - wid/2.0                         <!-- x0 start from south for north/top/bottom module -->
      widx = -wid                                                 <!-- since fpd is symmetric, true for ES module too  -->
    </Else>
    </If>

    <If expr="FBXD_Type.eq.2"  >
      y1 =  FBXD_NY*wid/2.0 - wid/2.0 + (16*widL-FBXD_NY*wid)/2.0   <!-- in order to correct the differences between              -->
      widy = wid+(16.0*widL-FBXD_NY*wid)/23.0                       <!-- 3 small cells and 2 large ones (see again in 17 lines)   -->
    <Else  >
      y1 =  FBXD_NY*wid/2.0 - wid/2.0                           
      widy = wid 
    </Else>
    </If>

    z1 = -FBXD_Depth/2.0 + FBXD_ZOffset + ztot 
    <Do var="i" from="1" to="FBXD_NY"  >
      x1=x0 
      <Do var="j" from="1" to="FBXD_NX"  >
	<If expr="FBXD_Type.eq.2.and.j.lt.6.and.i.gt.7.and.i.lt.18"  >
	  x1=x1+widx 
	<Else  >
	  <Create    block="FTOW"  />
	  <Placement block="FTOW" y="y1" x="x1" z="z1"   />
	  x1=x1+widx 
	</Else>
	</If>
      </Do>
      y1 =  y1-widy 
    </Do>

    <If expr="FBXD_Type.eq.1"  >
      x1=x0 
      y1= -rtot + ztot 
      z1=-FBXD_Depth/2.0  + FBXD_PSOffset + wid/2.0 
      <Do var="j" from="1" to="FBXD_NX"  >
	<Create block="FTOW"  />
	<Placement block="FTOW" y="y1" x="x1" z="z1"   >
	  <Rotation alphax="90"  />
	</Placement>

	x1=x1-wid 
      </Do>

      <If expr="fmcg_PbPlate==1"  >
	<Create block="PBPT"  />
	<Placement y="0" x="0" z="PBPD_Thick/2.0-FBXD_Depth/2.0" block="PBPT"  >
	</Placement>

      </If>

      ztotsmd=FMXG_G10Thick+FMXG_Sapex 
      <Create     block="FSHM"  />
      <Placement  block="FSHM" y="0" x="0" z="FBXD_SmdOff+ztotsmd-FBXD_Depth/2.0"  />


    </If>


    <If expr="FBXD_Type.ge.2"  >
      <Use struct="FLGG" select="Type" value="2 "  />
      <Use struct="FLGM" select="Type" value="2 "  />
      wid  = FLGG_Width + FLGG_DGap +  FLGG_AlThick*2.0 
      ztot = FLGG_Depth/2.0 
      rtot = FBXD_NXL*wid/2.0 
      bwid = rtot 
      xlcOffSet = (FBXD_Width-FBXD_NXL*wid)/2.0          ! Large Cells OffSet in X 
      <If expr="FPOS_iMod.eq.4"  >
	x0 =  -bwid + wid/2.0 - xlcOffSet 
	widx = wid 
	<Elif expr="FPOS_iMod.eq.3"  >
	  x0 =  +bwid - wid/2.0 + xlcOffSet  
	  widx = -wid 
	</Elif>

      </If>

      y1 =  FBXD_NYL*wid/2.0 - wid/2.0 
      z1 = -FBXD_Depth/2.0 + FBXD_ZOffset + ztot 
      <Do var="i" from="1" to="FBXD_NYL"  >
	x1=x0             
      <Do var="j" from="1" to="FBXD_NXL"  >
      <If expr="j.lt.9.and.i.gt.9.and.i.lt.26"  >
	      x1=x1+widx  
      <Elif expr="(i+j).ge.45"  >
	      <Create block="FALU"  />
	      <Placement y="y1" x="x1" z="z1" block="FALU"  />	
	      x1=x1+widx      
      <Elif expr="(j-i).ge.10"  >
              x1=x1+widx             
      </Elif>
      <Else  >
	      <Create block="FLXF"  />
	      <Placement y="y1" x="x1" z="z1" block="FLXF" />
	      x1=x1+widx 
      </Else>
      </Elif>
      </If>

      </Do>

      y1=y1-wid            
      </Do>

    </If>


    <If expr="FBXD_Type.eq.2"  >
      <Use struct="FLGG" select="Type" value="2 "  />
      <Use struct="FLGM" select="Type" value="2 "  />
      BZOffSet=0.0 
      wid  = FLGG_Width + FLGG_DGap  
      basewidth=1.0

      <Create    block="FBAS" />
      <Placement block="FBAS" 
		 z="-FBXD_Depth/2.0+BZOffSet+INSE_Depth/2.0"
		 y="-(FBXD_NXL*wid+basewidth/2.0)" 
		 x="FPOS_X"  />

    </If>


    <Create block="FENC"  />
    <Create block="FEAC"  />
    <Create block="FECC"  />
    <Create block="FEDC"  />
    <Create block="FEEC"  />
    distancer=INSE_GapHeight-(INSE_Height-2.0*INSE_SheetDpt) 
    xoffFECC=(INSE_SheetDpt-FBXD_Width)/2.0 
    zoffFECC=-FBXD_Depth/2.0+BZOffSet+INSE_Depth-INSE_GateGap 
    xoffFEDC=INSE_Width - INSE_SheetDpt 
    xoffFENC=(INSE_Width-FBXD_Width)/2.0 
    yoffFENC=(INSE_Height-INSE_SheetDpt)/2.0 
    zoffFENC=-FBXD_Depth/2.0 + BZOffSet + INSE_Depth/2.0 
    xshift=8*5.812-12*3.822+5*3.822-INSE_Width    !this is to move insert to small cell edge 
    <If expr="FBXD_Type.eq.2"  >
      <If expr="FPOS_iMod.eq.4"  >

	<Placement y="-yoffFENC" x="xoffFENC+xshift" z="zoffFENC" block="FENC"  >
	</Placement>

	<Placement y="yoffFENC" x="xoffFENC+xshift" z="zoffFENC" block="FENC"  >
	</Placement>

	<Placement y="0" x="INSE_Width+xshift-(FBXD_Width+INSE_SheetDpt)/2.0" z="-FBXD_Depth/2.0+BZOffSet+INSE_Depth/2.0" block="FEAC"  >
	</Placement>

	<Placement y="distancer/2.0" x="xoffFECC+xshift" z="zoffFECC-INSE_GateDepth-INSE_GapDepth/2.0" block="FECC"  >
	</Placement>

	<Placement y="distancer/2.0" x="xoffFECC+xshift" z="zoffFECC-2.0*INSE_GateDepth-3.0*INSE_GapDepth/2.0" block="FECC"  >
	</Placement>

	<Placement y="-distancer/2.0" x="xoffFECC+xshift" z="zoffFECC-INSE_GateDepth-INSE_GapDepth/2.0" block="FECC"  >
	</Placement>

	<Placement y="-distancer/2.0" x="xoffFECC+xshift" z="zoffFECC-2.0*INSE_GateDepth-3.0*INSE_GapDepth/2.0" block="FECC"  >
	</Placement>

	<Placement y="0" x="xshift+(xoffFEDC-FBXD_Width)/2.0" z="zoffFECC-INSE_GateDepth/2.0" block="FEDC"  >
	</Placement>

	<Placement y="0" x="xshift+(xoffFEDC-FBXD_Width)/2.0" z="zoffFECC-INSE_GateDepth-INSE_GapDepth-INSE_GateDepth/2.0" block="FEDC"  >
	</Placement>

	<Placement y="0" x="xshift+(xoffFEDC-FBXD_Width)/2.0" z="zoffFECC-2.0*(INSE_GateDepth+INSE_GapDepth)-INSE_GateDepth/2.0" block="FEDC"  >
	</Placement>


	<Elif expr="FPOS_iMod.eq.3"  >

	  <Placement y="-yoffFENC" x="-xoffFENC-xshift" z="zoffFENC" block="FENC"  >
	  </Placement>

	  <Placement y="yoffFENC" x="-xoffFENC-xshift" z="zoffFENC" block="FENC"  >
	  </Placement>

	  <Placement y="0" x="-xshift-INSE_Width+(FBXD_Width+INSE_SheetDpt)/2.0" z="-FBXD_Depth/2.0+BZOffSet+INSE_Depth/2.0" block="FEAC"  >
	  </Placement>

	  <Placement y="distancer/2.0" x="-xoffFECC-xshift" z="zoffFECC-INSE_GateDepth-INSE_GapDepth/2.0" block="FECC"  >
	  </Placement>

	  <Placement y="distancer/2.0" x="-xoffFECC-xshift" z="zoffFECC-2.0*INSE_GateDepth-3.0*INSE_GapDepth/2.0" block="FECC"  >
	  </Placement>

	  <Placement y="-distancer/2.0" x="-xoffFECC-xshift" z="zoffFECC-INSE_GateDepth-INSE_GapDepth/2.0" block="FECC"  >
	  </Placement>

	  <Placement y="-distancer/2.0" x="-xoffFECC-xshift" z="zoffFECC-2.0*INSE_GateDepth-3.0*INSE_GapDepth/2.0" block="FECC"  >
	  </Placement>

	  <Placement y="0" x="-xshift-(xoffFEDC-FBXD_Width)/2.0" z="zoffFECC-INSE_GateDepth/2.0" block="FEEC"  >
	  </Placement>

	  <Placement y="0" x="-xshift-(xoffFEDC-FBXD_Width)/2.0" z="zoffFECC-INSE_GateDepth-INSE_GapDepth-INSE_GateDepth/2.0" block="FEEC"  >
	  </Placement>

	  <Placement y="0" x="-xshift-(xoffFEDC-FBXD_Width)/2.0" z="zoffFECC-2.0*(INSE_GateDepth+INSE_GapDepth)-INSE_GateDepth/2.0" block="FEEC"  >
	  </Placement>

	</Elif>

      </If>

    </If>

  </Block>

  <Block name="FTOW" comment="is one PbG Tower"  >
    <Material name="Air"  />
    <Attribute for="FTOW" seen="1" colo="2"  />
    <Shape type="BOX" dz="ztot" dx="wid/2.0" dy="wid/2.0"  />

    <Create block="FWAL"  />
    <Placement z="-ztot+(FLGG_AlThick+FLGG_depth)/2.0" block="FWAL"  >
    </Placement>

    <Create block="FUMT"  />
    <Placement z="-ztot+FLGG_AlThick+FLGG_depth+FLGG_MuMetDz/2.0" block="FUMT"  >
    </Placement>

    <Create block="FPCT"  />
    <Placement z="-ztot+FLGG_AlThick+FLGG_depth+FLGG_PhCathDz/2.0" block="FPCT"  >
    </Placement>

  </Block>

  <Block name="FWAL" comment="is almunum wrapper"  >
    <Material name="Aluminium"  />
    <Attribute for="FWAL" seen="1" colo="3"  />
    <Shape type="BOX" dz="FLGG_Depth/2.0+FLGG_AlThick/2.0" dx="FLGG_Width/2.0+FLGG_AlThick" dy="FLGG_Width/2.0+FLGG_AlThick"  />
    <If expr="fmcg_ChkvSim==1"  >
      <Call expr="%Imed,N,E,ABSCO_Alm,EFFIC_all,RINDEX_Alm" routine="GSCKOV"  />
    </If>

    <Create block="FLGR"  />
      <Placement z="+FLGG_AlThick/2.0" block="FLGR"  >
    </Placement>

  </Block>

  <Block name="FLGR" comment="is Lead Glass detector"  >
    <Mixture name="PbG" dens="FLGM_Density" radl="FLGM_RadLen"  >
      <Component name="Pb" a="207.19" z="82" w=".60712"  />
      <Component name="K" a="39.102" z="19" w=".02324"  />
      <Component name="Si" a="28.088" z="14" w=".14771"  />
      <Component name="O" a="15.999" z="8" w=".22041"  />
      <Component name="As" a="74.922" z="33" w=".00152"  />
    </Mixture>

    <Medium name="leadglass" isvol="1 "  />
    <Attribute for="FLGR" seen="1" colo="4"  />
    <Shape type="BOX" dz="FLGG_depth/2.0" 
                      dx="FLGG_Width/2.0" 
                      dy="FLGG_Width/2.0"  />

    <Instrument block="FLGR">
      <Hit meas="flgr" nbits="0" min="0" max="250" />
      <Hit meas="elos" nbits="0" min="0" max="250" />
    </Instrument>

    <If expr="FMCG_ChkvSim==1"  >
      <Call expr="%Imed,N,E,ABSCO_PbG,EFFIC_All,RINDEX_PbG" routine="GSCKOV"  />
    </If>

  </Block>

  <Block name="FLXF" comment="is Lead Glass detector"  >
    <Mixture name="F2" dens="FLGM_Density" radl="FLGM_RadLen"  >
      <Component name="Pb" a="207.19" z="82" w=".41774"  />
      <Component name="K" a="39.102" z="19" w=".04151"  />
      <Component name="Si" a="28.088" z="14" w=".21047"  />
      <Component name="O" a="15.999" z="8" w=".29330"  />
      <Component name="Na" a="22.990" z="11" w=".03710"  />
    </Mixture>

    <Medium name="leadglass" isvol="1 "  />
    <Attribute for="FLXF" seen="1" colo="4"  />
    <Shape type="BOX" dz="FLGG_depth/2.0" dx="FLGG_Width/2.0" dy="FLGG_Width/2.0"  />
    <Instrument block="FLXF">
      <Hit meas="flxf" nbits="0" min="0" max="250" />
      <Hit meas="elos" nbits="0" min="0" max="250" />
    </Instrument>
  </Block>

  <Block name="FALU" comment="is Aluminium Base Cell"  >
    <Material name="Aluminium"  />
    <Attribute for="FALU" seen="1" colo="1"  />
    <Shape type="BOX" dz="FLGG_depth/2.0" dx="FLGG_Width/2.0" dy="FLGG_Width/2.0"  />
  </Block>

  <Block name="FBAS" comment="is Steel Base Plate"  >
    <Material name="Iron"  />
    <Attribute for="FBAS" seen="1" colo="1"  />
    <!-- ============================================================= -->
    <!-- basewidth is not initialized anywhere in original AgSTAR file -->
    <!-- ============================================================= -->
    <Shape type="BOX" dx="FBXD_Width/2.0" 
	   dy="basewidth/2.0" 
	   dz="INSE_Depth/2.0" />
    <!-- ============================================================= -->
  </Block>

  <Block name="FENC" comment="is Steel Enclosure"  >
    <Material name="Iron"  />
    <Attribute for="FENC" seen="1" colo="5"  />
    <Shape type="BOX" dz="INSE_Depth/2.0" dx="INSE_Width/2.0" dy="INSE_SheetDpt/2.0"  />
  </Block>


  <Block name="FEAC" comment="is Steel Enclosure"  >
    <Material name="Iron"  />
    <Attribute for="FEAC" seen="1" colo="5"  />
    <Shape type="BOX" dz="INSE_Depth/2.0" dx="INSE_SheetDpt/2.0" dy="(INSE_Height-2.0*INSE_SheetDpt)/2.0"  />
    <Create block="FEBC"  />
    <Placement y="0" x="0.0" z="-INSE_Depth/2.0+INSE_HoleDepth/2.0+INSE_HoleGap" block="FEBC"  >
    </Placement>


  </Block>


  <Block name="FEBC" comment="is Air square hole"  >
    <Material name="Air"  />
    <Attribute for="FEBC" seen="1" colo="5"  />
    <Shape type="BOX" dz="INSE_HoleDepth/2.0" dx="INSE_SheetDpt/2.0" dy="INSE_HoleHeight/2.0"  />
  </Block>


  <Block name="FECC" comment="is Steel distancer"  >
    <Material name="Iron"  />
    <Attribute for="FECC" seen="1" colo="5"  />
    <Shape type="BOX" dz="INSE_GapDepth/2.0" dx="INSE_SheetDpt/2.0" dy="INSE_GapHeight/2.0"  />
  </Block>


  <Block name="FEDC" comment="is Steel Enclosure part on south"  >
    <Material name="Iron"  />
    <Attribute for="FEDC" seen="1" colo="5"  />
    <Shape type="BOX" dz="INSE_GateDepth/2.0" dx="(xoffFEDC)/2.0" dy="(INSE_Height-2.0*INSE_SheetDpt)/2.0"  />
    <Create block="FERC"  />
    <Placement y="0" x="-(xoffFEDC)/2.0" z="0.0" block="FERC"  >
    </Placement>

    <Create block="FESC"  />
    <Placement y="INSE_Ra*sin(PI*5.0/12.0)" x="-(xoffFEDC)/2.0+INSE_Ra*cos(PI*5.0/12.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="INSE_Ra*sin(PI/4.0)" x="-(xoffFEDC)/2.0+INSE_Ra*cos(PI/4.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="INSE_Ra*sin(PI/12.0)" x="-(xoffFEDC)/2.0+INSE_Ra*cos(PI/12.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="-INSE_Ra*sin(PI/12.0)" x="-(xoffFEDC)/2.0+INSE_Ra*cos(PI/12.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="-INSE_Ra*sin(PI/4.0)" x="-(xoffFEDC)/2.0+INSE_Ra*cos(PI/4.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="-INSE_Ra*sin(PI*5.0/12.0)" x="-(xoffFEDC)/2.0+INSE_Ra*cos(PI*5.0/12.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="INSE_Rb*sin(PI/4.0)" x="-(xoffFEDC)/2.0+INSE_Rb*cos(PI/4.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="-INSE_Rb*sin(PI/4.0)" x="-(xoffFEDC)/2.0+INSE_Rb*cos(PI/4.0)" z="0.0" block="FESC"  >
    </Placement>

  </Block>


  <Block name="FEEC" comment="is Steel Enclosure part on north"  >
    <Material name="Iron"  />
    <Attribute for="FEEC" seen="1" colo="5"  />
    <Shape type="BOX" dz="INSE_GateDepth/2.0" dx="(xoffFEDC)/2.0" dy="(INSE_Height-2.0*INSE_SheetDpt)/2.0"  />
    <Create block="FETC"  />
    <Placement y="0" x="(xoffFEDC)/2.0" z="0.0" block="FETC"  >
    </Placement>

    <Create block="FESC"  />
    <Placement y="INSE_Ra*sin(PI*5.0/12.0)" x="(xoffFEDC)/2.0-INSE_Ra*cos(PI*5.0/12.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="INSE_Ra*sin(PI/4.0)" x="(xoffFEDC)/2.0-INSE_Ra*cos(PI/4.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="INSE_Ra*sin(PI/12.0)" x="(xoffFEDC)/2.0-INSE_Ra*cos(PI/12.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="-INSE_Ra*sin(PI/12.0)" x="(xoffFEDC)/2.0-INSE_Ra*cos(PI/12.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="-INSE_Ra*sin(PI/4.0)" x="(xoffFEDC)/2.0-INSE_Ra*cos(PI/4.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="-INSE_Ra*sin(PI*5.0/12.0)" x="(xoffFEDC)/2.0-INSE_Ra*cos(PI*5.0/12.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="INSE_Rb*sin(PI/4.0)" x="(xoffFEDC)/2.0-INSE_Rb*cos(PI/4.0)" z="0.0" block="FESC"  >
    </Placement>

    <Placement y="-INSE_Rb*sin(PI/4.0)" x="(xoffFEDC)/2.0-INSE_Rb*cos(PI/4.0)" z="0.0" block="FESC"  >
    </Placement>

  </Block>


  <Block name="FETC" comment="is Air Enclosure part"  >
    <Material name="Air"  />
    <Attribute for="FETC" seen="1" colo="6"  />
    <Shape type="tubs" rmin="0.0" rmax="INSE_RMax" dz="INSE_GateDepth/2.0" phi2="-90" phi1="90"  />
  </Block>

  <Block name="FERC" comment="is Air Enclosure part"  >
    <Material name="Air"  />
    <Attribute for="FERC" seen="1" colo="6"  />
    <Shape type="tubs" rmin="0.0" rmax="INSE_RMax" dz="INSE_GateDepth/2.0" phi2="90" phi1="-90"  />
  </Block>


  <Block name="FESC" comment="is Air Enclosure part"  >
    <Material name="Air"  />
    <Attribute for="FESC" seen="1" colo="6"  />
    <Shape type="tube" rmax="INSE_Diam/2.0" rmin="0.0" dz="INSE_GateDepth/2.0"  />
  </Block>

  <Block name="FPCT" comment="is Photo Cathode"  >
    <Material name="Air"  />
    <Medium name="PhotCath" isvol="1 "  />
    <Attribute for="LPCT" seen="1" colo="6"  />
    <Shape type="tube" dz="FLGG_PhCathDz/2.0" rmin="0" rmax="FLGG_PhCathR"  />
    <If expr="FMCG_ChkvSim==1"  >
      <Call expr="%Imed,N,E,ABSCO_PhCath,EFFIC_PhCath,RINDEX_PhCath" routine="GSCKOV"  />
      <Instrument block="FPCT">
	<Hit meas="user" nbits="0" min="0" max="100000" />
      </Instrument>
    </If>

  </Block>

  <Block name="FUMT" comment="is mu metal"  >
    <Material name="iron"  />
    <Attribute for="LUMT" seen="1" colo="5"  />
    <Shape type="tube" dz="FLGG_MuMetDz/2.0" rmin="FLGG_PhCathR" rmax="FLGG_MuMetR"  />
    <If expr="fmcg_ChkvSim==1"  >
      <Call expr="%Imed,N,E,ABSCO_MuMet,EFFIC_All,RINDEX_MuMet" routine="GSCKOV"  />
    </If>

  </Block>

  <Block name="PBPT" comment="is pb plate"  >
    <Material name="Lead"  />
    <Attribute for="PBPT" seen="1" colo="7"  />
    <Shape type="BOX" dz="PBPD_Thick/2.0" dx="PBPD_Width/2.0" dy="PBPD_Height/2.0"  />
  </Block>

  <Block name="FSHM" comment="is the SHower Max section"  >
    <Material name="Air"  />
    <Attribute for="FSHM" seen="1" colo="4"  />
    <Shape type="BOX" dz="ztotsmd" dx="FMXG_G10Width/2.0" dy="FMXG_G10hgt/2.0"  />
    wsmd=FMXG_Sbase/2.0+FMXG_Sgap 
    wtotsmd=(FMXG_Nstrip+1)*wsmd 
    zsmd=-ztotsmd+FMXG_G10Thick/2.0 
    <Create block="FXGT"  />
    <Placement y="0" x="0" z="zsmd" block="FXGT"  >
    </Placement>


    xsmdv=-wtotsmd/2.0-FMXG_Sgap/2.0+wsmd 
    ysmdv=0.0 
    zsmdv=zsmd+FMXG_G10Thick/2.0+FMXG_Sapex/2.0 
    <Do var="i" from="1" to="FMXG_Nstrip"  >
      <If expr="mod(i,2)!=0"  >
	<Create block="FHMS"  />
	<Placement y="ysmdv" x="xsmdv" z="zsmdv" block="FHMS"  >
	</Placement>

	<Else  >
	  <Create block="FHMS"  />
	  <Placement y="ysmdv" x="xsmdv" z="zsmdv" block="FHMS"  >
	    <Rotation alphax="180"  />
	  </Placement>

	</Else>

      </If>

      xsmdv=xsmdv+wsmd 
    </Do>


    zsmd2=zsmdv+FMXG_G10Thick/2.0+FMXG_Sapex/2.0 
    <Create block="FXGT"  />
    <Placement y="0" x="0" z="zsmd2" block="FXGT"  >
    </Placement>

    xsmdh=0.0 
    ysmdh=-wtotsmd/2.0-FMXG_Sgap/2.0+wsmd 
    zsmdh=zsmd2+FMXG_G10Thick/2.0+FMXG_Sapex/2.0 
    <Create block="FHMS"  />
    <Do var="i" from="1" to="FMXG_Nstrip"  >
      <If expr="mod(i,2)!=0"  >
	<Placement y="ysmdh" x="xsmdh" z="zsmdh" block="FHMS"  >
	  <Rotation ort="Y-XZ"  />
	</Placement>

	<Else  >
	  <Placement y="ysmdh" x="xsmdh" z="zsmdh" block="FHMS"  >
	    <Rotation ort="YX-Z"  />
	  </Placement>

	</Else>

      </If>

      ysmdh=ysmdh+wsmd 
    </Do>


  </Block>

  <Block name="FXGT" comment="is the G10 layer in the SMax"  >
    <Mixture name="g10" dens="1.7"  >
      <Component name="Si" a="28.08" z="14" w="0.6*1*28./60."  />
      <Component name="O" a="16" z="8" w="0.6*2*16./60."  />
      <Component name="C" a="12" z="6" w="0.4*8*12./174."  />
      <Component name="H" a="1" z="1" w="0.4*14*1./174."  />
      <Component name="O" a="16" z="8" w="0.4*4*16./174."  />
    </Mixture>

    <Attribute for="FXGT" seen="1" colo="7"  />
    <Shape type="BOX" dz="FMXG_G10Thick/2" dx="FMXG_G10Width/2" dy="FMXG_G10hgt/2"  />
    <Cut name="CUTGAM" value="0.00001"  />
    <Cut name="CUTELE" value="0.00001"  />
  </Block>

  <Block name="FHMS" comment="is sHower Max Strip"  >
    <Material name="POLYSTYREN"  />
    <Material name="Cpolystyren" isvol="1"  />
    <Attribute for="FHMS" seen="1" colo="2"  />
    <Shape type="TRD1" dz="fmxg_Sapex/2.0" dx2="fmxg_Sbase/2.0" dx1="0" dy="FMXG_G10hgt/2.0"  />
    <Cut name="CUTGAM" value="0.00008"  />
    <Cut name="CUTELE" value="0.001"  />
    <Cut name="BCUTE" value="0.0001"  />
    <Par name="BIRK1" value="1."  />
    <Par name="BIRK2" value="0.0130"  />
    <Par name="BIRK3" value="9.6E-6"  />
    <Instrument block="FHMS">
      <Hit meas="birk" nbits="0" min="0" max="10"/>
    </Instrument>
  </Block>


  <!-- ==
       == FMS Preshower Detector
       ==                                                                         -->
  <Block name="FPRS" comment="is box for plastic schinti FMS pre-shower detectors"  >

    <Material  name="Air"  />
    <Medium    name="standard"  />
    <Attribute for="FPRS" 
	       seen="0" 
	       colo="2"  
	       />

    <Shape type="PGON" 
	   phi1="45" dphi="360" npdiv="4" nz="2" 
	   zi="{-PRSW_DBox(3)/2.0,PRSW_DBox(3)/2.0}" 
	   rmn="{PRSW_DHole - PRSW_DxBbd(1),PRSW_DHole - PRSW_DxBbd(1)}" 
	   rmx="{PRSW_DBox(1)/2.0,PRSW_DBox(1)/2.0}" 
	   />  

    debug=0	     
    <If expr="debug.ge.1" > 
      npstype=0 
      cpstype(1)=1
      cpstype(2)=2
      cpstype(3)=6
      cpstype(4)=3
      cpstype(5)=4
      cpstype(6)=7
      cpstype(7)=5
      cpstype(8)=8
      <Export language="Mortran"> open(11,file='fpsgeom.txt',status='REPLACE')</Export>
    </If>
    
    <!-- .......................................................... First Layer -->
    serN=1 
    dx=PRSW_DBox(1)/2.0
    dy=PRSW_DBox(2)/2.0
    dz=PRSW_Dz(1)/2.0+PRSW_DzBbd(1)/2.0+PRSW_DSIPM(1)/2.0
    zz=-PRSW_Dbox(3)/2.0+dz
    <Create    block="FPLY"  />
    <Placement block="FPLY" in="FPRS" z="zz" konly="MANY"/>
    <!-- ........................................................  Second Layer -->
    serN=2 
    dx=PRSW_DBox(1)/2.0
    dy=PRSW_DBox(2)/2.0
    dz=PRSW_Dz(2)/2.0+PRSW_DzBbd(2)/2.0+PRSW_DSIPM(1)/2.0
    zz=-PRSW_Dbox(3)/2.0+dz+PRSW_Zoff(2)-PRSW_Zoff(1)
    <Create    block="FPLY"  />
    <Placement block="FPLY" in="FPRS" z="zz" konly="MANY" />

    <!-- .......................................................... Third Layer -->
    serN=3 
    dx=PRSW_DBox(1)/2.0
    dy=PRSW_DBox(2)/2.0
    dz=PRSW_Dz(3)/2.0+PRSW_DzBbd(3)/2.0
    zz=-PRSW_Dbox(3)/2.0+PRSW_DSIPM(1)+dz-PRSW_DzBbd(3)/2.0+PRSW_Zoff(3)-PRSW_Zoff(1)
    dzsb = PRSW_Dz(3)/2.0+PRSW_DzBbd(3)/4.0
    <Create     block="FPLY"  />
    <Placement  block="FPLY" in="FPRS" z="zz" konly="MANY" />

    <!-- ......................................................... Fourth Layer -->
    serN=4 
    dx=PRSW_DBox(1)/2.0
    dy=PRSW_DBox(2)/2.0
    dz=PRSW_Dz(4)/2.0+PRSW_DzBbd(4)/2.0+PRSW_DSIPM(1)/2.0
    zz=-PRSW_Dbox(3)/2.0+dz+PRSW_DSIPM(1)+PRSW_Zoff(4)-PRSW_Zoff(1)-PRSW_DzBbd(4) 
    <Create     block="FPLY"  />
    <Placement  block="FPLY" in="FPRS" z="zz" konly="MANY" />

    <If expr="debug.ge.1" > 
      <Export language="Mortran"> open(10,file='prs.txt',status='REPLACE')</Export>
      k=0
      <Do var="i" from="1" to="npstype" >
	<Do var="j" from="1" to="npstype" >
	  <If expr="i.eq.cpstype(j)">
	    <Export language="Mortran"> 
	      write(*,'(A5,A1,I5,F8.2,F8.2,F8.2)') 'Type=',char(ichar('A')+cpstype(j)-1),pstype(j),psdim(j,1)*2,psdim(j,2)*2,1.0
	      write(10,'(A5,A1,I5,F8.2,F8.2,F8.2)') 'Type=',char(ichar('A')+cpstype(j)-1),pstype(j),psdim(j,1)*2,psdim(j,2)*2,1.0
	    </Export>
	    k=k+pstype(j)
	  </If>
	</Do>		 
      </Do>
      <Export language="Mortran"> write(10,*) 'Total=',k </Export> 
      <Export language="Mortran"> close(10)</Export>
      <Export language="Mortran"> close(11)</Export>
    </If>
    
  </Block>

  <!--                                                    Preshower Layer:  FPLY -->
  <Block name="FPLY" comment="is a layer of FMS Preshower"  >         
    <Material  name="Air"  />
    <Medium    name="standard"  />
    <Attribute for="FPLY" seen="0" colo="3" serial="serN" />
    <!-- <Shape type="BOX" dx="dx" dy="dy" dz="dz" /> -->
    <Shape type="PGON"
	   phi1="45" dphi="360" npdiv="4" nz="2"
	   zi="{-dz,dz}"
	   rmn="{PRSW_DHole - PRSW_DxBbd(1),PRSW_DHole - PRSW_DxBbd(1)}"
	   rmx="{PRSW_DBox(1)/2.0,PRSW_DBox(1)/2.0}"
	   />
    
    lprs1=PRSW_NPrs(1)*(PRSW_DPrs(1)+PRSW_DPrs(3))                       <!-- width of narrow section -->
    lprs2=PRSW_NPrs(2)*(PRSW_DPrs(2)+PRSW_DPrs(3))+lprs1                 <!-- width of narrow+wide section --> 
    lprs3=(PRSW_NPrs(2)-PRSW_NSkipH)*(PRSW_DPrs(2)+PRSW_DPrs(3))+lprs1   <!-- width of narrow+wide for bottom horizontal -->
    lprs4=(PRSW_NPrs(1)-PRSW_NSkipV)*(PRSW_DPrs(1)+PRSW_DPrs(3))+PRSW_NPrs(2)*(PRSW_DPrs(2)+PRSW_DPrs(3))
    <!-- width of narrow+wide for bottom vertical -->
    dlg=(PRSW_DLG(2)+PRSW_DLG(3)+PRSW_DSIPM(1))/2.0
    
    k   = 0
    dzz = PRSW_DZ(serN)/2.0
    <If expr="serN.eq.3">               ! Pb in middle, back plate in front and back
      z1=0
      z2=0
    <Elif expr="serN.eq.4">             ! back board first for layer3
      z1=-dz+PRSW_DzBbd(serN)+dzz       ! z for schinti
      z2=-dz+PRSW_DzBbd(serN)/2.0       ! z for back board
    </Elif>
    <Else>                              ! back board 2nd for layer1,2
      z1=-dz+PRSW_DSIPM(1)+dzz          ! z for schinti
      z2=-dz+PRSW_DSIPM(1)+dzz*2+PRSW_DzBbd(serN)/2.0 ! z for back board
    </Else></If> 
    z = PRSW_Zoff(serN)

    <!-- Blocks can be created once.  Sized at position time -->
    <Create block="FPSC" />
    <Create block="FLIG" />
    <Create block="FLLG" />
    <Create block="WPAR" />
    <Create block="FPBB" />
    <Create block="FPPB" />
    
    <If expr="debug.ge.1 .and. serN.eq.1"> <Export language="Mortran"> open(1,file='prs1map.txt',status='REPLACE')</Export></If>
    <If expr="debug.ge.1 .and. serN.eq.2"> <Export language="Mortran"> open(2,file='prs2map.txt',status='REPLACE')</Export></If>
    <If expr="debug.ge.1 .and. serN.eq.3"> <Export language="Mortran"> open(3,file='prsCmap.txt',status='REPLACE')</Export></If>
    <If expr="debug.ge.1 .and. serN.eq.4"> <Export language="Mortran"> open(4,file='prs3map.txt',status='REPLACE')</Export></If>
    
    <If expr="serN.le.2" >
      layr=serN
      <Else>
	layr=serN-1
    </Else> </If>
    
    <If expr="serN.eq.1"> <Then> <!-- vertical plane --> 
      <Do var="lr" from="1" to="2"  > <!-- left and right half -->
	<Do var="tb" from="1" to="2"> <!-- top and bottom quad -->
	  x=0.0
	  quad=(lr-1)*2+tb
	  slat(quad,layr)=0
	  <Do var="j" from="1" to="2"> <!-- narrow/wide -->
	    <Do var="i" from="1" to="PRSW_NPrs(j)"> <!-- cell -->
	      dxx = PRSW_DPrs(j)/2.0
	      x = x + dxx + PRSW_DPrs(3)/2.0
	      <If expr="tb.eq.1"> 
		pwid=lprs2
		<Else>
		  pwid=lprs3-PRSW_DyCut
	      </Else></If>
	      <If expr="x.le.PRSW_DHole">
		dyy = (pwid-PRSW_DHole)/2.0
		y   = dyy+PRSW_DHole
	        <Else>
		  dyy = pwid/2.0
		  y   = dyy
	      </Else></If>
	      yy=y+dyy+dlg
	      <If expr="tb.eq.1"> rot=0</If>
	      <If expr="tb.eq.2"> y=-y; yy=-yy; rot=180</If>
	      <If expr="lr.eq.1"> xx=+x+PRSW_Xoff(serN)</If>
	      <If expr="lr.eq.2"> xx=-x-PRSW_Xoff(serN)</If>
	      y=y+PRSW_Yoff(serN); yy=yy+PRSW_Yoff(serN);
	      <If expr="tb.eq.1 .or. j.eq.2 .or. i.gt.PRSW_NSkipV">
		<If expr="debug.ge.1"> 
		  k   = k+1
		  slat(quad,layr)=slat(quad,layr)+1
		  id=(quad-1)*3*21+(layr-1)*21+(slat(quad,layr)-1)
		  flag=0
		  <Do var="kk" from="1" to="npstype"> 
		    <If expr="(psdim(kk,1).eq.dxx.and.psdim(kk,2).eq.dyy).or.(psdim(kk,1).eq.dyy.and.psdim(kk,2).eq.dxx)">
		      flag=kk
		      pstype(kk)=pstype(kk)+1
                    </If>
                  </Do>
                  <If expr="flag.eq.0">
		    npstype=npstype+1
		    flag=npstype
		    pstype(flag)=1
		    <If expr="dxx.gt.dyy">
                      psdim(npstype,1)=dyy
                      psdim(npstype,2)=dxx
                      <Else>
			psdim(npstype,1)=dxx
			psdim(npstype,2)=dyy
                    </Else></If>
                  </If>
		  <Export language="Mortran"> 
		    write(serN,'(I2,I3,F8.2,F8.2,F8.2,F8.2,F8.2,F8.2,2X,A1)') serN,k,dxx*2,dyy*2,dzz*2,xx,y,z,char(ichar('A')+cpstype(flag)-1)
		    write(11,'(I3,I2,I2,I3,F8.2,F8.2,F8.2,F8.2,F8.2,F8.2)') id,quad,layr,slat(quad,layr),dxx*2,dyy*2,dzz*2,xx,y,z
		  </Export> 
		</If>
		<Placement block="FPSC" x="xx" y="y" z="z1" dx="dxx" dy="dyy" dz="dzz" /> 
		<Placement block="FLIG" x="xx" y="yy" z="z1-PRSW_DSIPM(1)/2.0" if="j.eq.1"> <Rotation alphax="-90" /> <Rotation alphaz="rot" /></Placement>
		<Placement block="FLLG" x="xx" y="yy" z="z1-PRSW_DSIPM(1)/2.0" if="j.eq.2"> <Rotation alphax="-90" /> <Rotation alphaz="rot" /></Placement>
	      </If>
	      x = x + dxx
	    </Do>
	  </Do>
	</Do>
      </Do>
    </Then> 
    <Elif expr="serN.eq.2 .or. serN.eq.4"> <!-- horizontal plane --> 
      <Do var="lr" from="1" to="2"  > <!-- left and right half -->  
	<Do var="tb" from="1" to="2"> <!-- top and bottom quad -->
          y=0.0
          quad=(lr-1)*2+tb
          slat(quad,layr)=0
          <Do var="j" from="1" to="2"> <!-- narrow/wide -->
	    <Do var="i" from="1" to="PRSW_NPrs(j)"> <!-- cell -->
              dyy = PRSW_DPrs(j)/2.0		     
              y = y + dyy + PRSW_DPrs(3)/2.0
              pwid=lprs2
              <If expr="y.le.PRSW_DHole">
		dxx = (pwid-PRSW_DHole)/2.0
		x   = dxx+PRSW_DHole
	        <Else>
		  <If expr="tb.eq.1">
                    dxx = pwid/2.0
                    x   = dxx
                    <Else>
                      dxx = lprs4/2.0
                      x   = dxx+2*PRSW_DPrs(1)
                  </Else></If>
              </Else></If> 
              xx=x+dxx+dlg
              <If expr="tb.eq.1"> yy=+y; </If>
              <If expr="tb.eq.2"> yy=-y; </If>
              <If expr="lr.eq.1"> x=+x+PRSW_Xoff(serN); xx=+xx+PRSW_Xoff(serN); rot=-90</If>
              <If expr="lr.eq.2"> x=-x-PRSW_Xoff(serN); xx=-xx-PRSW_Xoff(serN); rot=90</If>
              yy=yy+PRSW_Yoff(serN);
              <If expr="tb.eq.1 .or. j.eq.1 .or. i.le.PRSW_NPrs(j)-PRSW_NSkipH">
		<If expr="debug.ge.1"> 
  		  k   = k+1
		  slat(quad,layr)=slat(quad,layr)+1
		  id=(quad-1)*3*21+(layr-1)*21+(slat(quad,layr)-1)
		  flag=0
		  <Do var="kk" from="1" to="npstype"> 
		    <If expr="(psdim(kk,1).eq.dxx.and.psdim(kk,2).eq.dyy).or.(psdim(kk,1).eq.dyy.and.psdim(kk,2).eq.dxx)">
		      flag=kk
		      pstype(kk)=pstype(kk)+1
                    </If>
                  </Do>
                  <If expr="flag.eq.0">
		    npstype=npstype+1
		    flag=npstype
		    pstype(flag)=1
		    <If expr="dxx.gt.dyy">
                      psdim(npstype,1)=dyy
                      psdim(npstype,2)=dxx
                      <Else>
			psdim(npstype,1)=dxx
			psdim(npstype,2)=dyy
                    </Else></If>
                  </If>		  
		  <Export language="Mortran"> 
		    write(serN,'(I2,I3,F8.2,F8.2,F8.2,F8.2,F8.2,F8.2,2X,A1)') serN,k,dxx*2,dyy*2,dzz*2,x,yy,z,char(ichar('A')+cpstype(flag)-1)
		    write(11,'(I3,I2,I2,I3,F8.2,F8.2,F8.2,F8.2,F8.2,F8.2)') id,quad,layr,slat(quad,layr),dxx*2,dyy*2,dzz*2,xx,y,z
                  </Export>
		</If>
		<Placement block="FPSC" x="x"  y="yy" z="z1" dx="dxx" dy="dyy" dz="dzz" /> 
		<Placement block="FLIG" x="xx" y="yy" z="z1-PRSW_DSIPM(1)/2.0" if="j.eq.1.and.serN.eq.2" > <Rotation alphax="-90" /> <Rotation alphaz="rot" /></Placement>
		<Placement block="FLLG" x="xx" y="yy" z="z1-PRSW_DSIPM(1)/2.0" if="j.eq.2.and.serN.eq.2" > <Rotation alphax="-90" /> <Rotation alphaz="rot" /></Placement>
		<Placement block="FLIG" x="xx" y="yy" z="z1+PRSW_DSIPM(1)/2.0" if="j.eq.1.and.serN.eq.4" > <Rotation alphax="90" /> <Rotation alphaz="-rot" /></Placement>
		<Placement block="FLLG" x="xx" y="yy" z="z1+PRSW_DSIPM(1)/2.0" if="j.eq.2.and.serN.eq.4" > <Rotation alphax="90" /> <Rotation alphaz="-rot" /></Placement>
              </If>
              y = y + dyy
            </Do>
          </Do>
	</Do>
      </Do>
    </Elif></If>	   
    <If expr="debug.ge.1"> <Export language="Mortran"> close(serN) </Export> </If>
    
    <!-- back plates and conveter -->
    dz1=PRSW_DzBbd(serN)/2.0
    dz3=PRSW_Dz(3)+PRSW_DzBbd(3)
    <!-- above beam pipe -->
    dx1=(PRSW_DHole-PRSW_DxBbd(1))/2.0
    dy1=(lprs2-PRSW_DHole+PRSW_DxBbd(1)+PRSW_DxBbd(2))/2.0
    x2=PRSW_xoff(serN)+dx1
    y2=PRSW_DHole-PRSW_DxBbd(1)+dy1
    dxx=dx1; dyy=dy1;
    <Placement block="FPBB" x="x2"  y="y2" z="z2"      dx="dx1" dy="dy1" dz="dz1"               if="serN.ne.3" />
    <Placement block="FPBB" x="-x2" y="y2" z="z2"      dx="dx1" dy="dy1" dz="dz1"               if="serN.ne.3" />
    <Placement block="FPBB" x="x2"  y="y2" z="z2-dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
    <Placement block="FPPB" x="x2"  y="y2" z="z2"      dx="dx1" dy="dy1" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />	   
    <Placement block="FPBB" x="x2"  y="y2" z="z2+dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   
    <Placement block="FPBB" x="-x2" y="y2" z="z2-dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
    <Placement block="FPPB" x="-x2" y="y2" z="z2"      dx="dx1" dy="dy1" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />
    <Placement block="FPBB" x="-x2" y="y2" z="z2+dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   
    
    <!-- top far -->
    dx2=(lprs2-PRSW_DHole+PRSW_DxBbd(1)+PRSW_DxBbd(2))/2.0                    
    dy2=(lprs2+PRSW_DxBbd(2))/2.0
    x2=PRSW_xoff(serN)+dx1*2+dx2
    y2=dy2                                                                                                                           
    dxx=dx2; dyy=dy2;
    <Placement block="FPBB" x="x2"  y="y2" z="z2"      dx="dx2" dy="dy2" dz="dz1" if="serN.ne.3" />
    <Placement block="FPBB" x="-x2" y="y2" z="z2"      dx="dx2" dy="dy2" dz="dz1" if="serN.ne.3" />	   
    <Placement block="FPBB" x="x2"  y="y2" z="z2-dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
    <Placement block="FPPB" x="x2"  y="y2" z="z2"      dx="dx2" dy="dy2" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />	   
    <Placement block="FPBB" x="x2"  y="y2" z="z2+dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   
    <Placement block="FPBB" x="-x2" y="y2" z="z2-dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
    <Placement block="FPPB" x="-x2" y="y2" z="z2"      dx="dx2" dy="dy2" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />
    <Placement block="FPBB" x="-x2" y="y2" z="z2+dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   
    
    <!-- below beam pipe -->
    dx1a=(PRSW_DHole-PRSW_DxBbd(1)-PRSW_NSkipV*PRSW_Dprs(1))/2.0
    dx1b=(PRSW_DHole-PRSW_DxBbd(1))/2.0
    <If expr="serN.le.4">
      dx1=dx1a
      x2=PRSW_xoff(serN)+PRSW_NSkipV*PRSW_Dprs(1)+dx1
      <Else>
	dx1=dx1b
	x2=PRSW_xoff(serN)+dx1
    </Else></If>
    dy1=(lprs3-PRSW_DHole-PRSW_DyCut+PRSW_DxBbd(1)+PRSW_DxBbd(2))/2.0
    y2=PRSW_DHole-PRSW_DxBbd(1)+dy1
    dxx=dx1; dyy=dy1;
    <Placement block="FPBB" x="x2"  y="-y2" z="z2" dx="dx1" dy="dy1" dz="dz1" if="serN.ne.3" />
    <Placement block="FPBB" x="-x2" y="-y2" z="z2" dx="dx1" dy="dy1" dz="dz1" if="serN.ne.3" />
    <Placement block="FPBB" x="x2"  y="-y2" z="z2-dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
    <Placement block="FPPB" x="x2"  y="-y2" z="z2"      dx="dx1" dy="dy1" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />	   
    <Placement block="FPBB" x="x2"  y="-y2" z="z2+dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   
    <Placement block="FPBB" x="-x2" y="-y2" z="z2-dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
    <Placement block="FPPB" x="-x2" y="-y2" z="z2"      dx="dx1" dy="dy1" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />
    <Placement block="FPBB" x="-x2" y="-y2" z="z2+dzsb" dx="dx1" dy="dy1" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   

    <!-- bottom far -->
    <If expr="serN.le.2"> 
      dx2=(lprs2-PRSW_DHole+PRSW_DxBbd(1)+PRSW_DxBbd(2))/2.0
      <Else>
	dx2=(lprs2-PRSW_DHole+PRSW_DxBbd(1)+PRSW_DxBbd(2))/2.0                    
    </Else></If>
    dy2=(lprs3-PRSW_DyCut+PRSW_DxBbd(2))/2.0
    x2=PRSW_xoff(serN)+dx1b*2+dx2
    y2=dy2                                                                                                                           
    dxx=dx2; dyy=dy2;
    <Placement block="FPBB" x="x2"  y="-y2" z="z2" dx="dx2" dy="dy2" dz="dz1" if="serN.ne.3" />
    <Placement block="FPBB" x="-x2" y="-y2" z="z2" dx="dx2" dy="dy2" dz="dz1" if="serN.ne.3" />
    <Placement block="FPBB" x="x2"  y="-y2" z="z2-dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
    <Placement block="FPPB" x="x2"  y="-y2" z="z2"      dx="dx2" dy="dy2" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />	   
    <Placement block="FPBB" x="x2"  y="-y2" z="z2+dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   
    <Placement block="FPBB" x="-x2" y="-y2" z="z2-dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />
    <Placement block="FPPB" x="-x2" y="-y2" z="z2"      dx="dx2" dy="dy2" dz="PRSW_Dz(3)/2.0"    if="serN.eq.3" />
    <Placement block="FPBB" x="-x2" y="-y2" z="z2+dzsb" dx="dx2" dy="dy2" dz="PRSW_DzBbd(3)/4.0" if="serN.eq.3" />	   
    
    <!-- Export language="Mortran"> write(*,*) 'Done serN=',serN</Export -->	   
  </Block>
  
  <Block name="FPBB" comment="is the G10 back board"  >
    <Mixture name="g10" dens="1.7"  >
      <Component name="Si" a="28.08" z="14" w="0.6*1*28./60."  />
      <Component name="O" a="16" z="8" w="0.6*2*16./60."  />
      <Component name="C" a="12" z="6" w="0.4*8*12./174."  />
      <Component name="H" a="1" z="1" w="0.4*14*1./174."  />
      <Component name="O" a="16" z="8" w="0.4*4*16./174."  />
    </Mixture>
    <Attribute for="FPBB" seen="1" colo="7"  />
    <Shape type="BOX" dx="0.0" dy="0.0" dz="0.0" />
  </Block>
  
  <Block name="FPPB" comment="is FMS PS Pb converter"  >
    <Material name="LEAD"  />
    <Attribute for="FPPB" seen="1" colo="6"  />
    <Shape type="BOX" dx="0.0" dy="0.0" dz="0.0" />
  </Block>
  
  <Block name="FPSC" comment="is a piece of scintillator in FMS Preshower"  >
    <Material name="Polystyren"  />
    <Material name="FMSPS_scint" isvol="1"  />
    <Attribute for="FPSC" seen="1" colo="4" />
    <Shape type="BOX" dx="0.0" dy="0.0" dz="0.0" />
    <Cut name="CUTGAM" value="0.00008" />
    <Cut name="CUTELE" value="0.001"   />
    <Cut name="BCUTE" value="0.0001"   />
    <Par name="BIRK1" value="1."       />
    <Par name="BIRK2" value="0.013"    />
    <Par name="BIRK3" value="9.6E-6"   />
    <Instrument block="FPSC">
      <Hit meas="birk" nbits="0" min="0" max="10" />
    </Instrument>
  </Block>
  
  <Block name="FLIG" comment="is a light guide + SiPM board for Preshower"  >
    <Material name="Air"  />
    <Attribute for="FLIG" seen="1" colo="6" serial="1"/>            
    <Shape type="BOX" dx="PRSW_DPRS(1)/2.0" dy="PRSW_Dz(1)/2.0+PRSW_DSIPM(1)/2.0" dz="dlg" />      
    <Create block="FLBA" />
    <Create block="FLCO" />
    <Create block="FPMT" />
    <Create block="FFEE" />
    <Placement block="FLBA" x="0" y="-PRSW_DSIPM(1)/2.0" z="PRSW_DLG(3)/2.0-dlg" /> 
    <Placement block="FLCO" x="-PRSW_DPRS(1)/4.0" y="-PRSW_DSIPM(1)/2.0" z="PRSW_DLG(3)+PRSW_DLG(2)/2.0-dlg" /> 
    <Placement block="FLCO" x="+PRSW_DPRS(1)/4.0" y="-PRSW_DSIPM(1)/2.0" z="PRSW_DLG(3)+PRSW_DLG(2)/2.0-dlg" /> 
    <Placement block="FPMT" x="0" y="-PRSW_DSIPM(1)/2.0" z="dlg-PRSW_DSIPM(1)/2.0" /> 
    <Placement block="FFEE" x="0" y="PRSW_Dz(1)/2.0" z="dlg-PRSW_DSIPM(4)/2.0" /> 
  </Block>
  
  <Block name="FLLG" comment="is a light guide + SiPM board for Preshower for large"  >
    <Material name="Air"  />
    <Attribute for="FLLG" seen="1" colo="6" serial="1"/>            
    <Shape type="BOX" dx="PRSW_DPRS(2)/2.0" dy="PRSW_Dz(1)/2.0+PRSW_DSIPM(1)/2.0" dz="dlg" />      
    <Create block="FBLL" />
    <Create block="FCLL" />
    <Create block="FPMT" />
    <Create block="FFEE" />
    <Placement block="FBLL" x="0" y="-PRSW_DSIPM(1)/2.0" z="PRSW_DLG(3)/2.0-dlg" /> 
    <Placement block="FCLL" x="-PRSW_DPRS(2)/4.0" y="-PRSW_DSIPM(1)/2.0" z="PRSW_DLG(3)+PRSW_DLG(2)/2-dlg" /> 
    <Placement block="FCLL" x=" PRSW_DPRS(2)/4.0" y="-PRSW_DSIPM(1)/2.0" z="PRSW_DLG(3)+PRSW_DLG(2)/2-dlg" /> 
    <Placement block="FPMT" x="0" y="-PRSW_DSIPM(1)/2.0" z="dlg-PRSW_DSIPM(1)/2.0" /> 
    <Placement block="FFEE" x="0" y="PRSW_Dz(1)/2.0" z="dlg-PRSW_DSIPM(4)/2.0" /> 
  </Block>
  
  <Block name="FLBA" comment="is a light guide base for Preshower"  >
    <Material name="Polystyren"  />
    <Attribute for="FLBA" seen="1" colo="4" serial="1"/>
    <Shape type="BOX" dx="PRSW_DPRS(1)/2.0" dy="PRSW_DZ(serN)/2.0" dz="PRSW_DLG(3)/2.0" />
  </Block>
  
  <Block name="FBLL" comment="is a light guide base for Preshower large"  >
    <Material name="Polystyren"  />
    <Attribute for="FBLL" seen="1" colo="4" serial="1"/>
    <Shape type="BOX" dx="PRSW_DPRS(2)/2.0" dy="PRSW_DZ(serN)/2.0" dz="PRSW_DLG(3)/2.0" />
  </Block>
  
  <Block name="FLCO" comment="is a light guide cone for Preshower"  >
    <Material name="Polystyren"  />
    <Attribute for="FLCO" seen="1" colo="4" serial="1"/>
    <Shape type="TRD2" dx1="PRSW_DPRS(1)/4.0" dx2="PRSW_DLG(1)/2.0" dy1="PRSW_DZ(serN)/2.0" dy2="PRSW_DLG(1)/2.0" dz="PRSW_DLG(2)/2.0" />
  </Block>
  
  <Block name="FCLL" comment="is a light guide cone for Preshower large"  >
    <Material name="Polystyren"  />
    <Attribute for="FCLL" seen="1" colo="4" serial="1"/>
    <Shape type="TRD2" dx1="PRSW_DPRS(2)/4.0" dx2="PRSW_DLG(1)/2.0" dy1="PRSW_DZ(serN)/2.0" dy2="PRSW_DLG(1)/2.0" dz="PRSW_DLG(2)/2.0" />
  </Block>
  
  <Block name="FPMT" comment="is a SiPM board for Preshower"  >
    <Material name="Polystyren"  />
    <Attribute for="FPMT" seen="1" colo="3" serial="1"/>
    <Shape type="BOX" dx="PRSW_DSIPM(2)/2.0" dy="PRSW_DSIPM(3)/2.0" dz="PRSW_DSIPM(1)/2.0" />
  </Block>
  
  <Block name="FFEE" comment="is a FEE board for Preshower"  >
    <Material name="Polystyren"  />
    <Attribute for="FEEE" seen="1" colo="3" serial="1"/>
    <Shape type="BOX" dx="PRSW_DSIPM(2)/2.0" dy="PRSW_DSIPM(1)/2.0" dz="PRSW_DSIPM(4)/2.0" />
  </Block>
  
  <Block name="WPPL" comment="is a pole for west platform"  >
    <Material name="Iron"  />
    <Attribute for="WPPL" seen="1" colo="4"  />
    <Shape type="BOX" dx="WPFM_PoleD(1)/2.0" dy="WPFM_PoleD(2)/2.0" dz="WPFM_PoleD(3)/2.0" />
    <Placement block="WPAR" dx="WPFM_PoleD(1)/2.0-WPFM_PoleD(4)" dy="WPFM_PoleD(2)/2.0" dz="WPFM_PoleD(3)/2.0-WPFM_PoleD(4)" 
               x="0.0" y="0.0" z="0.0" />
  </Block>
  
  <Block name="WPIS" comment="is a I-struct for west platform"  >
    <Material name="Iron"  />
    <Attribute for="WPIS" seen="1" colo="4"  />
    <Shape type="BOX" dx="WPFM_IstrD(1)/2.0" dy="WPFM_IstrD(2)/2.0" dz="WPFM_IstrD(3)/2.0" />
    <Placement block="WPAR" dx="WPFM_IstrD(1)/2.0" dy="WPFM_IstrD(2)/2.0-WPFM_IstrD(4)" dz="(WPFM_IstrD(3)/2.0-WPFM_IstrD(4)/2.0)/2.0" 
               x="0.0" y="0.0" z="+(WPFM_IstrD(3)/4.0-WPFM_IstrD(4)/2.0)" />
    <Placement block="WPAR" dx="WPFM_IstrD(1)/2.0" dy="WPFM_IstrD(2)/2.0-WPFM_IstrD(4)" dz="(WPFM_IstrD(3)/2.0-WPFM_IstrD(4)/2.0)/2.0" 
               x="0.0" y="0.0" z="-(WPFM_IstrD(3)/4.0-WPFM_IstrD(4)/2.0)" />
  </Block>
  
  <Block name="WPUF" comment="is a front U-struct for west platform"  >
    <Material name="Iron"  />
    <Attribute for="WPUF" seen="1" colo="4"  />
    <Shape type="BOX" dx="WPFM_UstFD(1)/2.0" dy="WPFM_UstFD(2)/2.0" dz="WPFM_UstFD(3)/2.0" />
    <Placement block="WPAR" dx="WPFM_UstFD(1)/2.0" dy="WPFM_UstFD(2)/2.0-WPFM_UstFD(4)" dz="WPFM_UstFD(3)/2.0-WPFM_UstFD(4)/2.0" 
               x="0.0" y="0.0" z="WPFM_UstFD(4)/2.0" />
  </Block>
  
  <Block name="WPUN" comment="is a north U-struct for west platform"  >
    <Material name="Iron"  />
    <Attribute for="WPUN" seen="1" colo="4"  />
    <Shape type="BOX" dx="WPFM_UstND(1)/2.0" dy="WPFM_UstND(2)/2.0" dz="WPFM_UstND(3)/2.0" />
    <Placement block="WPAR" dx="WPFM_UstND(1)/2.0-WPFM_UstND(4)/2.0" dy="WPFM_UstND(2)/2.0-WPFM_UstND(4)" dz="WPFM_UstND(3)/2.0" 
               x="+WPFM_UstND(4)/2.0" y="0.0" z="0.0" />
  </Block>
  
  <Block name="WPUS" comment="is a south U-struct for west platform"  >
    <Material name="Iron"  />
    <Attribute for="WPUS" seen="1" colo="4"  />
    <Shape type="BOX" dx="WPFM_UstSD(1)/2.0" dy="WPFM_UstSD(2)/2.0" dz="WPFM_UstSD(3)/2.0" />
    <Placement block="WPAR" dx="WPFM_UstSD(1)/2.0-WPFM_UstSD(4)/2.0" dy="WPFM_UstSD(2)/2.0-WPFM_UstSD(4)" dz="WPFM_UstSD(3)/2.0" 
               x="-WPFM_UstSD(4)/2.0" y="0.0" z="0.0" />
  </Block>
  
  <Block name="WPAR" comment="is a platform structs air"  >
    <Material name="Air"  />
    <Attribute for="WPAR" seen="1" colo="0"  />
    <Shape type="BOX" dx="0.0" dy="0.0" dz="0.0" />
  </Block>
  
</Module>

<Export language="Mortran">
  subroutine fmsdigitizationmodule(JJ,HIT)

+CDE,TYPING,GCBANK,GCONST,GCUNIT,GCTMED,GCTRAK,GCKINE,GCSETS,AGCSTEP,GCVOLU.

  Integer JJ
  Real HIT,att,dzhit,zback,lamb
  Real zcenter, box(3), foo(3), dx, dy, dz, z
  Equivalence (box(1),dx)
  Equivalence (box(2),dy)
  Equivalence (box(3),dz)
  Integer :: npar, natt, istat
  Real depth
  LOGICAL isSet /.false./
  LOGICAL doAttenuation /.false./
  character*4 name

  Structure FMCG { version, chkvsim, pbplane, fmsnx, fmssx, atten }

  ENTRY FLGR HIT (jj,hit) """Entry point for FLGR hits"""
  IF (isSet.eqv..FALSE.) THEN
  lamb   = 0.04             ! attenuation = exp(-lamb * (zback-zhit))
  isSet  = .true.
  ENDIF

  ENTRY FLXF HIT (jj,hit) """Entry point for FLXF hits"""
  IF (isSet.eqv..FALSE.) THEN
  lamb   = 0.03
  isSEt  = .true.
  ENDIF

  att = 1.0

  !
  ! Check whether to run attenuation or not
  !
  USE /DETM/FPDM/FMCG stat=istat
  IF (istat.ge.0.) { "negative indicates failure mode"

    IF (fmcg_atten=1.0) {

      ! This is the center of the detector
      zcenter = gtran(3,NLEVEL)

      ! Obtain dimensions of the detector (assumes a box)
      ! dz is the half width of the box
      call gfpara(names(nlevel),number(nlevel),1,npar,natt,box,foo)

      ! Compute the front of the detector
      zback = zcenter + dz

      ! Distance from back of detector to hit
      dzhit = zback - VECT(3) 
      IF (dzhit.gt.0) THEN """ Rare -1E-3cm hit positions """
         ! Calculate attenuation
         att=exp(-lamb * dzhit)
      ELSE
          att=1.0
      ENDIF
    }

  }

  ! reset
  isSet = .false.

  ! Attenuated energy loss
  hit = deStep * att

  z = vect(3)
  call uhtoc(NAMES(NLEVEL),4,name,4)
  !write (*,*) name, 'z=',z, 'dz=',dzhit,'step=',step,'dE=',deStep, 'alpha=',att

  return
  end 

</Export>   

</Document>

