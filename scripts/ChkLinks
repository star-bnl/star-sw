#!/usr/local/bin/perl 

#
# Wrapper for linkcheck. 
# linkcheck program is a perl script available from CPAN. Please, 
# install it where you see fit and on your WebServer. Configure
# the top portion of this warpper.
#
# This script can be used under the terms of the GNU public license.
# 
# The 2 first arguments will modify the next variables in order
#
$FLNM      = "Broken.html";                           # name of report
$URL       = "http://www.star.bnl.gov/";              # URL to analyze


$LINKCHECK = "/usr/local/bin/linkcheck";              # linkcheck program
$ARGS      = "--recurse --verbosity 2";               # linkcheck options
$CHCOL     = 0;                                       # change color if same ws
$MAXBRK    = 50;                                      # stop listing broken links when exceeded

$TARGETD   = "/afs/rhic.bnl.gov/star/doc_public/www/html/tmp/";  # output directory
@EXCLUDED  = ("protected",
	      "phpMyAdmin",
	      "HyperNews-star");                      # patterns to exclude

$BGATTRIB  = "bgcolor=cornsilk text=black link=navy vlink=maroon alink=tomato";
$FONT      = "<basefont face=\"verdana,arial,helvetica,sans-serif\">";

$IMG1      = "<IMG SRC=\"/icons/forward.gif\" BORDER=0>";   
                                                      # Text/Image each page
$IMG2      = "<IMG SRC=\"/icons/bomb.gif\"    BORDER=0>";   
                                                      # Text/Image for broken
$IMG3      = "(more)";                                # Text/Image cross-link



# ----------------- NOTHING TO CHANGE BELOW THIS LINE --------------------
# First Argument may be an alternate file name
$FLNM = $ARGV[0] if( defined($ARGV[0]) );
# Second argument may be a WebSite to scan
$URL  = $ARGV[1] if( defined($ARGV[1]) );


# This command might bomb so trap, STDERR
#$FILIN = "/tmp/chklinks8318";
if ( ! -d "/tmp/ChkLinks"){ mkdir("/tmp/ChkLinks",0755);}
$FILIN = "/tmp/ChkLinks/$$";

open(SAVEOUT,">&STDOUT"); open(STDOUT,">$FILIN.log"); select(STDOUT); $| = 1;
open(SAVEERR,">&STDERR"); open(STDERR,">$FILIN.err"); select(STDERR); $| = 1;
# flock(STDOUT,LOCK_SH); flock(STDERR,LOCK_SH);

`$LINKCHECK $ARGS $URL`;

close(STDERR); open(STDERR,">&SAVEERR");
close(STDOUT); open(STDOUT,">&SAVEOUT");


# Start with a finer grain report i.e. sort by own many
# links are broken in a given page.
#$0     =~ m/(.*\/)(.*)/;
#$PRGM  = $2;
$cpage = "";
$BCOUNT= $COUNT = 0;


if ( ! open(FI,"$FILIN.log")){    
    print "Could not open $FILIN.log\n";
    exit;
}

while ( defined($line = <FI>) ){
    chomp($line);
    if( $line =~ /(PAGE )(.*)/){
	$cpage = $2;
	$COUNT++;

    } elsif( $line =~ /BROKEN/){
	$skip = 0;
	foreach $pat (@EXCLUDED){
	    if($line =~ /$pat/){
		$skip = 1;
		last;
	    }
	}
	if($skip){ next;}
	
	# Ok, go now ..
	$BCOUNT++;
	chomp($line);
	@items = split(" ",$line);

	# First, count of broken links per page
	if( defined($PAGE{$items[1]}) ){
	    $PAGE{$items[1]}++;
	    $pat = $items[3];
	    $pat =~ s/\+//g;
	    if( $REFS{$items[1]} !~ /$pat\|/){
		$REFS{$items[1]} .= "$items[3]|";
	    }
	} else {
	    $PAGE{$items[1]} = 1;
	    $REFS{$items[1]} = "$items[3]|";
	}

	# Now, tree of broken links i.e. where a broken
	# link appears. 
	if( defined($BROKEN{$items[3]}) ){
	    $pat = $items[1];
	    $pat =~ s/\+//g;
	    if( $BROKEN{$items[3]} !~ /$pat\|/){
		$BROKEN{$items[3]} .= "$items[1]|";
	    }
	} else {
	    $BROKEN{$items[3]}  = "$items[1]|";
	}
    }
}
close(FI);


if ( open(FO,">$TARGETD/$FLNM-tmp") ){   # If not, forget it
    print FO 
	"<HTML>\n",
	"<HEAD><TITLE>Broken links in $URL</TITLE></HEAD>\n",
	"<BODY $BGATTRIB>\n$FONT\n",
	"<!-- Page AutoGenerated on ".localtime()." (c) J.Lauret -->\n",
	"<H1>List of broken links in <tt>$URL</tt></h1>\n",
	"<I>Auto-Generated on ".localtime()."</I>\n",
	"<UL>\n",
	"<LI>$COUNT Pages Scanned, $BCOUNT broken\n",
	"<LI><A HREF=\"#PagesWithBrokenLinks\">Pages with Broken Links</A>\n",
	"<LI><A HREF=\"#BrokenLinksIn\">Broken Links reference list</A>\n",
	"<LI><A HREF=\"#Full\">Full report</A>\n",
	"</UL>\n",
	"<P>\n";
    

    ########## DISPLAY 1  #########################
    print FO
	"<HR WIDTH=\"80%\"><H2><A NAME=\"PagesWithBrokenLinks\">Pages with Broken Links</A></H2>",
	"<DL>\n";
    foreach $el (sort {$PAGE{$b} <=> $PAGE{$a}} keys %PAGE){
	$sel = $el;
	$sel =~ s/$URL//;
	print FO "<P><DT>$IMG1 &nbsp; $PAGE{$el} broken link in <TT><A HREF=\"$el\">$sel</A></TT>\n";

	@items = split(/\|/,$REFS{$el});
	print FO " <UL>\n";
	$kk = 0;
	foreach $line (@items){
	    $l = &GetRef($line);
	    $kk++;
	    if ( $kk < $MAXBRK){
		if( $line =~ /$URL/ && $CHCOL){
		    print FO " <LI><FONT COLOR=\"#FF0000\"><TT>$line</TT></FONT>".
			"<A HREF=\"#$l\">$IMG3</A>\n";
		} else {
		    print FO " <LI><TT>$line</TT> <A HREF=\"#$l\">$IMG3</A>\n";
		}
	    } else {
		print FO " <LI><TT>...</TT> ".($#items+1)." broken links, only $MAXBRK shown\n";
		last;
	    }
	}
	print FO " </UL>\n";
    }
    print FO 
	"</DL>\n";


    ########## DISPLAY 2  #########################
    print FO
	"<HR WIDTH=\"80%\"><H2><A NAME=\"BrokenLinksIn\">Broken Links reference list</A></H2>",
	"<DL>\n";
    foreach $el (sort keys %BROKEN){
	$l = &GetRef($el);
	print FO "<P><DT><A NAME=\"$l\"></A>$IMG2 &nbsp; <TT>$el</TT> appears in\n";
	@items = split(/\|/,$BROKEN{$el});
	print FO " <UL>\n";
	foreach $line (@items){
	    $sel = $line;
	    $sel =~ s/$URL//;
	    print FO " <LI><tt><A HREF=\"$line\">$sel</A></tt>\n";
	}
	print FO " </UL>\n";
    }
    print FO
	"</DL>\n";


    ########## DISPLAY 3  #########################
    print FO
	"<HR WIDTH=\"80%\"><H2><A NAME=\"Full\">Full report</A></H2>",
	"<PRE>\n";
    if ( ! open(FI,$FILIN.".log")){    
	print "Could not open $FILIN.log\n";
	exit;
    }
    while ( defined($line = <FI>) ){
	if($line =~ /PAGE /){ next;}
	chomp($line);
	$skip = 0;
	foreach $pat (@EXCLUDED){
	    if($line =~ /$pat/){
		$skip = 1;
		last;
	    }
	}
	if($skip){ next;}
	print FO "$line\n";
    }
    print FO "</PRE>\n";
    close(FO);
    close(FI);

    # Safely move now that IO are all done.
    if( -e "$TARGETD/$FLNM-tmp"){
	@items = stat("$TARGETD/$FLNM-tmp");
	if( $items[7] != 0){
	    if ( ! rename("$TARGETD/$FLNM-tmp","$TARGETD/$FLNM") ){
		die "Could not rename file to $TARGETD/$FLNM (see $FILIN.log)\n";
	    } else {
		#unlink($FILIN);
	    }
	}
    }
} else {
    die "Could not open $TARGETD/$FLNM-tmp . Leaving $FILIN.log\n";
}




sub GetRef
{
    my($l)=@_;

    $l =~ s/[\#\/:]/_/g;
    $l =~ s/[\.%&]/-/g;
    $l;
}
